{{ define "main" }}
<article class="post single">
    <header class="post-header">
        <h1 class="post-title">
            {{ .Title }}
        </h1>
        {{ if not .Date.IsZero }}
        <div class="post-meta">
            <time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
                {{ .Date.Format "January 2, 2006" }}
            </time>
            • {{ .FuzzyWordCount }} words
            • {{ .ReadingTime }} min read
            {{ if .Params.external_url }}
                • <a href="{{ .Params.external_url }}" target="_blank" rel="noopener">via</a>
            {{ end }}
            • <a href="#" id="share-link" title="Copy short link" aria-label="Copy short link" style="text-decoration:none">∞</a>
            <span id="share-status"></span>
        </div>
        {{ end }}
    </header>
    <div class="post-content">
        {{ .Content }}
    </div>
</article>

<footer class="feedback-footer">
  <p>Have feedback, comments, or ideas? <a href="mailto:info@philippdubach.com">I'd love to hear from you</a>.</p>
  <p class="latest-post">Latest: <a href="{{ (index (where .Site.RegularPages "Section" "posts") 0).RelPermalink }}">{{ (index (where .Site.RegularPages "Section" "posts") 0).Title }}</a></p>
  <p class="most-read" id="top-post-week" style="min-height: 1.5em;">
    <!-- Populated by JS -->
  </p>
</footer>

<script>
(function(){
  // Fetch top post from GoatCounter
  var container = document.getElementById('top-post-week');
  if (container) {
    fetch('https://weekly-top-goatcounter-api.philippd.workers.dev')
      .then(function(r) { return r.ok ? r.json() : Promise.reject(new Error('API request failed')); })
      .then(function(data) {
        if (data.hits && data.hits.length > 0) {
          var t = data.hits[0];
          container.innerHTML = 'Most read: <a href="' + t.path + '">' + t.title.replace(' - philippdubach.com', '') + '</a>';
        } else { container.remove(); }
      })
      .catch(function() { container.remove(); });
  }

  // Share link handler - copies short URL to clipboard
  // Lightweight, works on all browsers (desktop + mobile)
  var link = document.getElementById('share-link');
  var status = document.getElementById('share-status');
  if (!link) return;

  // Cross-browser clipboard copy (works on iOS Safari, older browsers)
  function copyText(text, cb) {
    function fallbackCopy() {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly', '');
      ta.style.cssText = 'position:fixed;left:-9999px;top:0;opacity:0';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try { ta.setSelectionRange(0, ta.value.length); } catch (e) {}
      var ok = false;
      try { ok = document.execCommand('copy'); } catch (e) { ok = false; }
      document.body.removeChild(ta);
      cb(ok);
    }

    // Try modern API first, but fall back if it fails (Safari/iOS can reject).
    if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function' && window.isSecureContext) {
      navigator.clipboard.writeText(text).then(function() {
        cb(true);
      }).catch(function() {
        fallbackCopy();
      });
      return;
    }

    fallbackCopy();
  }

  // Get canonical URL once
  var canonical = document.querySelector('link[rel="canonical"]');
  var pageUrl = (canonical ? canonical.href : location.href).replace(/\/+$/, '').split('?')[0];
  var shortUrl = null; // Cache the short URL after first fetch
  var storageKey = 'shorturl:' + pageUrl;
  try { shortUrl = localStorage.getItem(storageKey) || null; } catch (e) {}

  link.addEventListener('click', function(e) {
    e.preventDefault();
    
    // If we already have the short URL cached, just copy it
    if (shortUrl) {
      copyText(shortUrl, function(ok) {
        status.textContent = ok ? 'short url copied' : shortUrl;
        setTimeout(function() { status.textContent = ''; }, 2500);
      });
      return;
    }

    status.textContent = '...';

    // Fetch short URL with timeout
    var done = false;
    var tid = setTimeout(function() {
      if (done) return;
      done = true;
      copyText(pageUrl, function(ok) {
        status.textContent = ok ? 'url copied' : pageUrl;
        setTimeout(function() { status.textContent = ''; }, 2500);
      });
    }, 3000);

    fetch('https://yourls-shortener-proxy.philippd.workers.dev/shorten?url=' + encodeURIComponent(pageUrl))
      .then(function(r) { return r.ok ? r.json() : Promise.reject(); })
      .then(function(d) {
        if (done) return;
        done = true;
        clearTimeout(tid);
        // YOURLS returns shorturl for both new and existing URLs
        var url = d && d.shorturl ? d.shorturl : pageUrl;
        if (d && d.shorturl) {
          shortUrl = d.shorturl;
          try { localStorage.setItem(storageKey, shortUrl); } catch (e) {}
        }
        copyText(url, function(ok) {
          status.textContent = ok ? (d && d.shorturl ? 'short url copied' : 'url copied') : url;
          setTimeout(function() { status.textContent = ''; }, 2500);
        });
      })
      .catch(function() {
        if (done) return;
        done = true;
        clearTimeout(tid);
        copyText(pageUrl, function(ok) {
          status.textContent = ok ? 'url copied' : pageUrl;
          setTimeout(function() { status.textContent = ''; }, 2500);
        });
      });
  });
})();
</script>

{{ end }}