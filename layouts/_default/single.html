{{ define "main" }}
<article class="post single">
    <header class="post-header">
        <h1 class="post-title">
            {{ .Title }}
        </h1>
        {{ if not .Date.IsZero }}
        <div class="post-meta">
            <time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
                {{ .Date.Format "January 2, 2006" }}
            </time>
            • {{ .FuzzyWordCount }} words
            • {{ .ReadingTime }} min read
            {{ if .Params.external_url }}
                • <a href="{{ .Params.external_url }}" target="_blank" rel="noopener">via</a>
            {{ end }}
            • <a href="#" id="share-link" title="Copy short link" aria-label="Copy short link" style="text-decoration:none">∞</a>
            <span id="share-status"></span>
        </div>
        {{ end }}
    </header>
    <div class="post-content">
        {{ .Content }}
    </div>
</article>

<footer class="feedback-footer">
  <p>Have feedback, comments, or ideas? <a href="mailto:info@philippdubach.com">I'd love to hear from you</a>.</p>
  <p class="latest-post">Latest: <a href="{{ (index (where .Site.RegularPages "Section" "posts") 0).RelPermalink }}">{{ (index (where .Site.RegularPages "Section" "posts") 0).Title }}</a></p>
  <p class="most-read" id="top-post-week" style="min-height: 1.5em;">
    <!-- Populated by JS -->
  </p>
</footer>

<script>
(function(){
  // Fetch top post from GoatCounter
  var container = document.getElementById('top-post-week');
  if (container) {
    fetch('https://weekly-top-goatcounter-api.philippd.workers.dev')
      .then(function(r) { return r.ok ? r.json() : Promise.reject(new Error('API request failed')); })
      .then(function(data) {
        if (data.hits && data.hits.length > 0) {
          var t = data.hits[0];
          container.innerHTML = 'Most read: <a href="' + t.path + '">' + t.title.replace(' - philippdubach.com', '') + '</a>';
        } else { container.remove(); }
      })
      .catch(function() { container.remove(); });
  }

  // Share link handler - copies page URL to clipboard
  // Uses YOURLS shortener proxy worker, falls back to canonical URL if unavailable
  var link = document.getElementById('share-link');
  var status = document.getElementById('share-status');
  if (!link) return;
  
  link.addEventListener('click', function(e) {
    e.preventDefault();
    status.textContent = '...';
    
    // Get canonical URL or fallback to current URL
    var canonical = document.querySelector('link[rel="canonical"]');
    var pageUrl = canonical ? canonical.href : window.location.href;
    // Clean URL: remove trailing slashes and query params for consistency
    var cleanUrl = pageUrl.replace(/\/+$/, '').split('?')[0];
    
    // Use the YOURLS shortener proxy worker endpoint
    // This proxies to YOURLS API with server-side authentication
    var apiEndpoint = 'https://yourls-shortener-proxy.philippd.workers.dev/shorten?url=' + encodeURIComponent(cleanUrl);
    var timeoutMs = 3000;
    
    // Create abort controller for timeout
    var controller = typeof AbortController !== 'undefined' ? new AbortController() : null;
    var timeoutId = controller ? setTimeout(function() { controller.abort(); }, timeoutMs) : null;
    
    // Function to copy text and show status
    var copyAndShow = function(text, isShort) {
      if (timeoutId) clearTimeout(timeoutId);
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
          status.textContent = isShort ? 'short url copied' : 'url copied';
          setTimeout(function() { status.textContent = ''; }, 2500);
        }).catch(function() {
          status.textContent = text; // Show URL if copy fails
          setTimeout(function() { status.textContent = ''; }, 4000);
        });
      } else {
        status.textContent = text;
        setTimeout(function() { status.textContent = ''; }, 4000);
      }
    };
    
    // Try to get short URL, fallback to full URL on any error
    fetch(apiEndpoint, controller ? { signal: controller.signal } : {})
      .then(function(r) {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(function(data) {
        if (data && data.shorturl && data.status === 'success') {
          copyAndShow(data.shorturl, true);
        } else if (data && data.shorturl) {
          // URL already exists, use existing short URL
          copyAndShow(data.shorturl, true);
        } else {
          throw new Error('No short URL returned');
        }
      })
      .catch(function(err) {
        // Service unavailable, timeout, or error - fallback to canonical URL
        console.log('Short URL unavailable, using canonical:', err.message || err);
        copyAndShow(cleanUrl, false);
      });
  });
})();
</script>

{{ end }}