{{ define "main" }}
<article class="post single">
    <header class="post-header">
        <h1 class="post-title">
            {{ .Title }}
        </h1>
        {{ if not .Date.IsZero }}
        <div class="post-meta">
            <time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
                {{ .Date.Format "January 2, 2006" }}
            </time>
            • {{ .FuzzyWordCount }} words
            • {{ .ReadingTime }} min read
            {{ if .Params.external_url }}
                • <a href="{{ .Params.external_url }}" target="_blank" rel="noopener">via</a>
            {{ end }}
            • <a href="#" id="share-link" title="Copy short link" aria-label="Copy short link" style="text-decoration:none">∞</a>
            <span id="share-status"></span>
        </div>
        {{ end }}
    </header>
    <div class="post-content">
        {{ .Content }}
    </div>
</article>

<footer class="feedback-footer">
  <p>Have feedback, comments, or ideas? <a href="mailto:info@philippdubach.com">I'd love to hear from you</a>.</p>
  <p><a href="/subscribe/">Subscribe</a> for monthly updates.</p>
  <p class="latest-post">Latest: <a href="{{ (index (where .Site.RegularPages "Section" "posts") 0).RelPermalink }}">{{ (index (where .Site.RegularPages "Section" "posts") 0).Title }}</a></p>
  <p class="most-read" id="top-post-week" style="min-height: 1.5em;">
    <!-- Populated by JS -->
  </p>
</footer>

<script>
(function(){
  // Fetch top post from GoatCounter
  var container = document.getElementById('top-post-week');
  if (container) {
    fetch('https://weekly-top-goatcounter-api.philippd.workers.dev')
      .then(function(r) { return r.ok ? r.json() : Promise.reject(); })
      .then(function(data) {
        if (data.hits && data.hits.length > 0) {
          var t = data.hits[0];
          container.innerHTML = 'Most read: <a href="' + t.path + '">' + t.title.replace(' - philippdubach.com', '') + '</a>';
        } else { container.remove(); }
      })
      .catch(function() { container.remove(); });
  }

  // Share link handler
  var link = document.getElementById('share-link');
  var status = document.getElementById('share-status');
  if (!link) return;
  
  link.addEventListener('click', function(e) {
    e.preventDefault();
    status.textContent = '...';
    var pageUrl = window.location.href;
    
    // Safari requires ClipboardItem with Promise for async clipboard writes
    // The Promise must be created synchronously during the user gesture
    if (navigator.clipboard && navigator.clipboard.write && typeof ClipboardItem !== 'undefined') {
      var clipboardItem = new ClipboardItem({
        'text/plain': fetch('https://pdub.click/yourls-api.php?signature=4807288869&action=shorturl&format=json&url=' + encodeURIComponent(pageUrl))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var short = data.shorturl || '';
            return new Blob([short], { type: 'text/plain' });
          })
          .catch(function() {
            return new Blob([''], { type: 'text/plain' });
          })
      });
      navigator.clipboard.write([clipboardItem]).then(function() {
        status.textContent = 'url copied';
        setTimeout(function() { status.textContent = ''; }, 2000);
      }).catch(function() {
        status.textContent = 'error';
        setTimeout(function() { status.textContent = ''; }, 2000);
      });
    } else {
      // Fallback for older browsers without ClipboardItem support
      fetch('https://pdub.click/yourls-api.php?signature=4807288869&action=shorturl&format=json&url=' + encodeURIComponent(pageUrl))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var short = data.shorturl;
          if (short && navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(short).then(function() {
              status.textContent = 'url copied';
              setTimeout(function() { status.textContent = ''; }, 2000);
            }).catch(function() {
              status.textContent = short;
              setTimeout(function() { status.textContent = ''; }, 4000);
            });
          } else if (short) {
            status.textContent = short;
            setTimeout(function() { status.textContent = ''; }, 4000);
          } else {
            status.textContent = 'error';
            setTimeout(function() { status.textContent = ''; }, 2000);
          }
        })
        .catch(function() {
          status.textContent = 'error';
          setTimeout(function() { status.textContent = ''; }, 2000);
        });
    }
  });
})();
</script>

{{ end }}