{{/* ============================================================
  Structured Data — @graph pattern with @id cross-references

  Entities:
  - Person (@id: #person) — author identity, E-E-A-T signals
  - WebSite (@id: #website) — site-level metadata
  - BlogPosting/TechArticle/Article (@id: #article) — per-page content
  - BreadcrumbList — navigation hierarchy
  - ProfilePage — about page
  - CollectionPage — research page
  - FAQPage — posts with FAQ frontmatter
============================================================ */}}

{{/* Build unified sameAs array from hugo.toml params */}}
{{- $sameAs := slice -}}
{{- with .Site.Params.social.github }}{{ $sameAs = $sameAs | append (printf "https://github.com/%s" .) }}{{ end -}}
{{- with .Site.Params.social.bluesky }}{{ $sameAs = $sameAs | append (printf "https://bsky.app/profile/%s" .) }}{{ end -}}
{{- with .Site.Params.social.twitter }}{{ $sameAs = $sameAs | append (printf "https://x.com/%s" .) }}{{ end -}}
{{- with .Site.Params.social.linkedin }}{{ $sameAs = $sameAs | append (printf "https://www.linkedin.com/in/%s/" .) }}{{ end -}}
{{- with .Site.Params.academic.google_scholar }}{{ $sameAs = $sameAs | append . }}{{ end -}}
{{- with .Site.Params.academic.researchgate }}{{ $sameAs = $sameAs | append . }}{{ end -}}
{{- with .Site.Params.academic.orcid }}{{ $sameAs = $sameAs | append . }}{{ end -}}

{{/* Reusable @id references */}}
{{- $personId := printf "%s#person" .Site.BaseURL -}}
{{- $websiteId := printf "%s#website" .Site.BaseURL -}}

{{/* Person entity — consistent across all pages */}}
{{- $person := dict
  "@type" "Person"
  "@id" $personId
  "name" .Site.Params.author
  "url" (printf "%sabout/" .Site.BaseURL)
  "jobTitle" "Strategy Consultant & Independent Researcher"
  "description" "Strategy consultant and independent researcher in quantitative finance and machine learning."
  "alumniOf" (dict "@type" "CollegeOrUniversity" "name" "Imperial College London")
  "knowsAbout" .Site.Params.keywords
  "sameAs" $sameAs
-}}

{{/* WebSite entity */}}
{{- $website := dict
  "@type" "WebSite"
  "@id" $websiteId
  "name" .Site.Title
  "url" (print .Site.BaseURL)
  "description" .Site.Params.description
  "inLanguage" (.Site.Language.Lang | default "en")
  "publisher" (dict "@id" $personId)
-}}

{{/* ===== HOMEPAGE: Person + WebSite ===== */}}
{{ if .IsHome }}
<script type="application/ld+json">
{{ dict "@context" "https://schema.org" "@graph" (slice $person $website) | jsonify | safeJS }}
</script>
{{ end }}

{{/* ===== ABOUT PAGE: Person + ProfilePage ===== */}}
{{ if eq .RelPermalink "/about/" }}
<script type="application/ld+json">
{{ dict "@context" "https://schema.org" "@graph" (slice $person (dict "@type" "ProfilePage" "mainEntity" (dict "@id" $personId))) | jsonify | safeJS }}
</script>
{{ end }}

{{/* ===== RESEARCH PAGE: CollectionPage with ScholarlyArticle items ===== */}}
{{ if eq .RelPermalink "/research/" }}
{{ with .Site.Data.research }}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Research",
  "description": "{{ $.Params.description }}",
  "url": "{{ $.Permalink }}",
  "author": {
    "@id": "{{ $personId }}"
  },
  "hasPart": [
    {{- $first := true -}}
    {{- range .publications -}}
      {{- range .items -}}
        {{- if not $first }},{{ end -}}
        {{- $first = false }}
    {
      "@type": "ScholarlyArticle",
      "headline": "{{ .title }}",
      "name": "{{ .title }}",
      {{ with .summary }}"abstract": {{ . | jsonify }},{{ end }}
      "author": {
        "@id": "{{ $personId }}"
      }
      {{ with .doi }},"url": "https://dx.doi.org/{{ . }}"{{ end }}
    }
      {{- end -}}
    {{- end }}
  ]
}
</script>
{{ end }}
{{ end }}

{{/* ===== BREADCRUMBS: Single pages ===== */}}
{{ if .IsPage }}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "{{ .Site.BaseURL }}"
    }
    {{ if .Section }},
    {
      "@type": "ListItem",
      "position": 2,
      "name": "{{ .Section | humanize }}",
      "item": "{{ .Site.BaseURL }}{{ .Section }}/"
    }
    {{ end }},
    {
      "@type": "ListItem",
      "position": {{ if .Section }}3{{ else }}2{{ end }},
      "name": "{{ .Title }}",
      "item": "{{ .Permalink }}"
    }
  ]
}
</script>
{{ end }}

{{/* ===== BREADCRUMBS: Section and taxonomy pages ===== */}}
{{ if and (not .IsPage) (not .IsHome) }}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "{{ .Site.BaseURL }}"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "{{ .Title }}",
      "item": "{{ .Permalink }}"
    }
  ]
}
</script>
{{ end }}

{{/* ===== ARTICLE PAGES: Person + WebSite + Article @graph ===== */}}
{{ if and .IsPage (ne .RelPermalink "/about/") }}
{{- $articleType := "BlogPosting" -}}
{{- if eq .Params.type "Project" }}{{ $articleType = "TechArticle" }}{{ end -}}
{{- if eq .Params.type "Essay" }}{{ $articleType = "Article" }}{{ end -}}
{{- if eq .Params.type "Review" }}{{ $articleType = "Review" }}{{ end -}}

{{- $desc := .Description -}}
{{- if not $desc }}{{ $desc = .Summary | plainify | truncate 160 }}{{ end -}}

{{- $article := dict
  "@type" $articleType
  "@id" (printf "%s#article" .Permalink)
  "headline" .Title
  "name" .Title
  "description" $desc
  "articleBody" (.Content | plainify)
  "wordCount" .WordCount
  "timeRequired" (printf "PT%dM" .ReadingTime)
  "inLanguage" (.Site.Language.Lang | default "en")
  "datePublished" (.Date.Format "2006-01-02T15:04:05Z07:00")
  "dateModified" (.Lastmod.Format "2006-01-02T15:04:05Z07:00")
  "author" (dict "@id" $personId)
  "publisher" (dict "@id" $personId)
  "isPartOf" (dict "@id" $websiteId)
  "mainEntityOfPage" (dict "@type" "WebPage" "@id" .Permalink)
  "speakable" (dict "@type" "SpeakableSpecification" "cssSelector" (slice ".post-content > p:first-of-type" ".post-header h1"))
-}}

{{/* Conditional: keywords */}}
{{- if .Params.keywords }}
  {{- $article = merge $article (dict "keywords" .Params.keywords) -}}
{{- else if .Params.tags }}
  {{- $article = merge $article (dict "keywords" .Params.tags) -}}
{{- end }}

{{/* Conditional: about (from categories) */}}
{{- if .Params.categories }}
  {{- $aboutList := slice -}}
  {{- range .Params.categories }}
    {{- $aboutList = $aboutList | append (dict "@type" "Thing" "name" .) -}}
  {{- end }}
  {{- $article = merge $article (dict "about" $aboutList) -}}
{{- end }}

{{/* Conditional: Project proficiency */}}
{{- if eq .Params.type "Project" }}
  {{- $article = merge $article (dict "proficiencyLevel" "Expert") -}}
{{- end }}

{{/* Conditional: external source citation */}}
{{- with .Params.external_url }}
  {{- $article = merge $article (dict "citation" (dict "@type" "CreativeWork" "url" .)) -}}
{{- end }}

{{/* Conditional: DOI sameAs */}}
{{- with .Params.doi }}
  {{- $article = merge $article (dict "sameAs" (printf "https://doi.org/%s" .)) -}}
{{- end }}

{{/* Conditional: image */}}
{{- $image := "" -}}
{{- if .Params.images }}
  {{- $image = index .Params.images 0 -}}
  {{- if not (hasPrefix $image "http") }}{{ $image = $image | absURL }}{{ end -}}
{{- else if .Params.image }}
  {{- $image = .Params.image | absURL -}}
{{- else if .Site.Params.default_image }}
  {{- $image = .Site.Params.default_image -}}
{{- end }}
{{- if $image }}
  {{- $article = merge $article (dict "image" (dict "@type" "ImageObject" "url" $image "width" 1200 "height" 630)) -}}
{{- end }}

<script type="application/ld+json">
{{ dict "@context" "https://schema.org" "@graph" (slice $person $website $article) | jsonify | safeJS }}
</script>

{{/* FAQPage Schema — for posts with FAQ frontmatter */}}
{{ with .Params.faq }}
{{- $mainEntity := slice }}
{{- range . }}
{{- $questionItem := dict "@type" "Question" "name" .question "acceptedAnswer" (dict "@type" "Answer" "text" .answer) }}
{{- $mainEntity = $mainEntity | append $questionItem }}
{{- end }}
{{- $schema := dict "@context" "https://schema.org" "@type" "FAQPage" "mainEntity" $mainEntity }}
<script type="application/ld+json">
{{ $schema | jsonify | safeJS }}
</script>
{{ end }}
{{ end }}
