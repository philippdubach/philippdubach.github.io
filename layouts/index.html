{{ define "main" }}
{{ $allPosts := where (where .Site.RegularPages "Section" "posts") ".Params.unlisted" "ne" true }}
{{ $projects := where $allPosts ".Params.type" "Project" }}
{{ $projects := $projects.ByDate.Reverse }}
{{ $posts := where $allPosts ".Params.type" "!=" "Project" }}
{{ $posts := $posts.ByDate.Reverse }}
{{ $cdnBase := "https://static.philippdubach.com" }}

<div class="home">

    <h1 class="home-heading">Quantitative Finance, AI & Technology</h1>
    <p class="home-intro">{{ .Site.Params.sidebar_description | default "Writing about quantitative finance, AI, and technology." }}</p>

    {{/* ===== TAB NAVIGATION ===== */}}
    <nav class="home-tabs" role="tablist" aria-label="Content sections">
        <button class="home-tab home-tab--active"
                role="tab"
                aria-selected="true"
                aria-controls="feed-blog"
                data-target="feed-blog"
                id="tab-blog">Articles ({{ len $posts }})</button>
        <button class="home-tab"
                role="tab"
                aria-selected="false"
                aria-controls="feed-projects"
                data-target="feed-projects"
                id="tab-projects">Projects ({{ len $projects }})</button>
    </nav>

    {{/* ===== BLOG FEED ===== */}}
    <section class="home-feed home-feed--active"
             id="feed-blog"
             role="tabpanel"
             aria-labelledby="tab-blog">
        <div class="home-feed-list" id="blog-list" aria-live="polite">
            {{ $blogScratch := newScratch }}
            {{ $blogScratch.Set "prevYear" 0 }}
            {{ range $i, $page := $posts }}
            {{ $yearChanged := and (gt $i 0) (ne ($page.Date.Year) ($blogScratch.Get "prevYear")) }}
            <article class="home-row" data-index="{{ $i }}">
                <a href="{{ $page.Permalink }}" class="home-row-link">
                    <time class="home-row-date" datetime="{{ $page.Date.Format "2006-01-02" }}">{{ $page.Date.Format "Jan 2" }}{{ if $yearChanged }}<span class="home-row-date-year">{{ $page.Date.Year }}</span>{{ end }}</time>
                    {{ with $page.Params.images }}{{ $imgPath := replace (index . 0) "https://static.philippdubach.com/" "" }}
                    <div class="home-row-thumb">
                        <img src="{{ $cdnBase }}/cdn-cgi/image/width=360,quality=80,format=auto/{{ $imgPath }}"
                             srcset="{{ $cdnBase }}/cdn-cgi/image/width=200,quality=80,format=webp/{{ $imgPath }} 200w,
                                     {{ $cdnBase }}/cdn-cgi/image/width=360,quality=80,format=webp/{{ $imgPath }} 360w,
                                     {{ $cdnBase }}/cdn-cgi/image/width=540,quality=80,format=webp/{{ $imgPath }} 540w"
                             sizes="(max-width: 768px) 100px, 180px"
                             alt="{{ $page.Title }}"
                             loading="{{ if lt $i 6 }}eager{{ else }}lazy{{ end }}"
                             width="360" height="189"
                             decoding="async">
                    </div>
                    {{ end }}
                    <div class="home-row-body">
                        <h2 class="home-row-title">{{ $page.Title }}</h2>
                        {{ with $page.Params.description }}
                        <p class="home-row-desc">{{ . }}</p>
                        {{ end }}
                        <span class="home-row-date-mobile">
                            <time datetime="{{ $page.Date.Format "2006-01-02" }}">{{ $page.Date.Format "Jan 2, 2006" }}</time>
                        </span>
                        <span class="home-row-reading">{{ $page.ReadingTime }} min read</span>
                        {{ with $page.Params.categories }}<span class="home-row-cat">{{ index . 0 }}</span>{{ end }}
                    </div>
                </a>
            </article>
            {{ $blogScratch.Set "prevYear" ($page.Date.Year) }}
            {{ end }}
        </div>
        {{ if gt (len $posts) 6 }}
        <div class="home-divider" id="blog-divider">
            <button class="home-divider-btn" data-target="blog-list" data-step="6">Load more posts</button>
        </div>
        {{ end }}
    </section>

    {{/* ===== PROJECTS FEED ===== */}}
    <section class="home-feed"
             id="feed-projects"
             role="tabpanel"
             aria-labelledby="tab-projects">
        <div class="home-feed-list" id="projects-list" aria-live="polite">
            {{ $projScratch := newScratch }}
            {{ $projScratch.Set "prevYear" 0 }}
            {{ range $i, $page := $projects }}
            {{ $yearChanged := and (gt $i 0) (ne ($page.Date.Year) ($projScratch.Get "prevYear")) }}
            <article class="home-row" data-index="{{ $i }}">
                <a href="{{ $page.Permalink }}" class="home-row-link">
                    <time class="home-row-date" datetime="{{ $page.Date.Format "2006-01-02" }}">{{ $page.Date.Format "Jan 2" }}{{ if $yearChanged }}<span class="home-row-date-year">{{ $page.Date.Year }}</span>{{ end }}</time>
                    {{ with $page.Params.images }}{{ $imgPath := replace (index . 0) "https://static.philippdubach.com/" "" }}
                    <div class="home-row-thumb">
                        <img src="{{ $cdnBase }}/cdn-cgi/image/width=360,quality=80,format=auto/{{ $imgPath }}"
                             srcset="{{ $cdnBase }}/cdn-cgi/image/width=200,quality=80,format=webp/{{ $imgPath }} 200w,
                                     {{ $cdnBase }}/cdn-cgi/image/width=360,quality=80,format=webp/{{ $imgPath }} 360w,
                                     {{ $cdnBase }}/cdn-cgi/image/width=540,quality=80,format=webp/{{ $imgPath }} 540w"
                             sizes="(max-width: 768px) 100px, 180px"
                             alt="{{ $page.Title }}"
                             loading="lazy"
                             width="360" height="189"
                             decoding="async">
                    </div>
                    {{ end }}
                    <div class="home-row-body">
                        <h2 class="home-row-title">{{ $page.Title }}</h2>
                        {{ with $page.Params.description }}
                        <p class="home-row-desc">{{ . }}</p>
                        {{ end }}
                        <span class="home-row-date-mobile">
                            <time datetime="{{ $page.Date.Format "2006-01-02" }}">{{ $page.Date.Format "Jan 2, 2006" }}</time>
                        </span>
                        <span class="home-row-reading">{{ $page.ReadingTime }} min read</span>
                        {{ with $page.Params.categories }}<span class="home-row-cat">{{ index . 0 }}</span>{{ end }}
                    </div>
                </a>
            </article>
            {{ $projScratch.Set "prevYear" ($page.Date.Year) }}
            {{ end }}
        </div>
        {{ if gt (len $projects) 6 }}
        <div class="home-divider" id="projects-divider">
            <button class="home-divider-btn" data-target="projects-list" data-step="6">Load more projects</button>
        </div>
        {{ end }}
    </section>

</div>

<script>
(function () {
    'use strict';

    /* Progressive disclosure: hide rows beyond first 6 via JS (SEO: all rows visible to crawlers) */
    var lists = document.querySelectorAll('.home-feed-list');
    for (var l = 0; l < lists.length; l++) {
        var rows = lists[l].querySelectorAll('.home-row');
        for (var r = 6; r < rows.length; r++) {
            rows[r].classList.add('home-row--hidden');
        }
    }

    /* Tab switching */
    var tabs = document.querySelectorAll('.home-tab');
    for (var t = 0; t < tabs.length; t++) {
        tabs[t].addEventListener('click', function () {
            for (var j = 0; j < tabs.length; j++) {
                tabs[j].classList.remove('home-tab--active');
                tabs[j].setAttribute('aria-selected', 'false');
            }
            this.classList.add('home-tab--active');
            this.setAttribute('aria-selected', 'true');

            var feeds = document.querySelectorAll('.home-feed');
            var target = document.getElementById(this.getAttribute('data-target'));
            for (var k = 0; k < feeds.length; k++) {
                feeds[k].classList.remove('home-feed--active');
            }
            if (target) {
                target.classList.add('home-feed--active');
            }
        });
    }

    /* Load more */
    var dividers = document.querySelectorAll('.home-divider-btn');
    for (var d = 0; d < dividers.length; d++) {
        dividers[d].addEventListener('click', function () {
            var list = document.getElementById(this.getAttribute('data-target'));
            if (!list) return;
            var step = parseInt(this.getAttribute('data-step'), 10);
            var hidden = list.querySelectorAll('.home-row--hidden');
            var count = Math.min(step, hidden.length);

            for (var i = 0; i < count; i++) {
                hidden[i].classList.remove('home-row--hidden');
            }

            if (list.querySelectorAll('.home-row--hidden').length === 0) {
                this.parentElement.style.display = 'none';
            }
        });
    }
})();
</script>
{{ end }}
