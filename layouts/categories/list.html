{{ define "main" }}
<div class="archive">
    {{ if eq .Title "Categories" }}
    {{/* Main categories index page - show all categories with their posts */}}
    <h1>Categories</h1>
    
    {{ range $name, $taxonomy := .Site.Taxonomies.categories }}
    <section class="category-section">
        {{ $catPosts := where $taxonomy.Pages ".Params.unlisted" "ne" true }}
        <h2 class="category-heading">{{ $taxonomy.Page.Title }} <span class="category-post-count">({{ len $catPosts }})</span></h2>
        {{ $posts := $catPosts.ByDate.Reverse }}
        {{ range $posts }}
        <article class="archive-item">
            <div class="archive-meta">
                <time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
                    {{ .Date.Format "Jan 2, 2006" }}
                </time>
            </div>
            <div class="archive-title">
                <a href="{{ .Permalink }}">
                    {{ .Title }}
                    {{ if eq .Params.type "Project" }}
                       <span class="project-tag">PROJECT</span>
                    {{ end }}
                </a>
            </div>
        </article>
        {{ end }}
    </section>
    {{ end }}
    
    {{ else }}
    {{/* Individual category page */}}
    <h1>{{ .Title }}</h1>

    {{ with .Content }}
    <div class="archive-description">{{ . }}</div>
    {{ end }}

    {{ $filteredPages := where .Pages ".Params.unlisted" "ne" true }}
    <p class="category-post-count">{{ len $filteredPages }} posts</p>

    {{ $posts := $filteredPages.ByDate.Reverse }}
    {{ range $posts.GroupByDate "2006" }}
    <section class="year">
        <h2>{{ .Key }}</h2>
        {{ range .Pages }}
        <article class="archive-item">
            <div class="archive-meta">
                <time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
                    {{ .Date.Format "Jan 2" }}
                </time>
            </div>
            <div class="archive-title">
                <a href="{{ .Permalink }}">
                    {{ .Title }}
                    {{ if eq .Params.type "Project" }}
                       <span class="project-tag">PROJECT</span>
                    {{ end }}
                </a>
            </div>
        </article>
        {{ end }}
    </section>
    {{ end }}
    {{/* Cross-category navigation */}}
    <nav class="category-nav" aria-label="Browse other categories">
        {{ range $name, $taxonomy := .Site.Taxonomies.categories }}
        {{ if ne $taxonomy.Page.Title $.Title }}
        <a href="{{ $taxonomy.Page.Permalink }}">{{ $taxonomy.Page.Title }}</a>
        {{ end }}
        {{ end }}
    </nav>

    {{/* CollectionPage JSON-LD for category pillar pages */}}
    {{- $hasPart := slice -}}
    {{- range $filteredPages.ByDate.Reverse -}}
      {{- $hasPart = $hasPart | append (dict "@id" (printf "%s#article" .Permalink)) -}}
    {{- end }}
    <script type="application/ld+json">
    {{ dict "@context" "https://schema.org" "@type" "CollectionPage" "name" .Title "description" (.Description | default (printf "Articles on %s" .Title)) "url" .Permalink "about" (dict "@type" "Thing" "name" .Title) "numberOfItems" (len $filteredPages) "hasPart" $hasPart "author" (dict "@id" (printf "%s#person" .Site.BaseURL)) | jsonify | safeJS }}
    </script>
    {{ end }}
</div>
{{ end }}
