<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Post Composer - philippdubach.com</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✍️</text></svg>">
    
    <!-- KaTeX for math rendering (pinned version with SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Ber31g5zrIv68kCDlKv7WMv5p2e7LLcXUAiXjgjM" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

    <!-- Highlight.js for code syntax highlighting (pinned version with SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css" integrity="sha384-fDmq7q7V9rGEj8HFPK/GpFUFvPvK6t4N87M/V1VtH9GxW0RIHl/m0K5zI8N4fGGH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js" integrity="sha384-9mu2JKpUImscOMmwjm1y6MA2YsW3amSoFNYwKeUHxaXYKQ1nakyFABLLprXMlRf5" crossorigin="anonymous"></script>

    <!-- Marked.js for markdown parsing (pinned version with SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js" integrity="sha384-zbcZnSE5o4W0rScUfU/w1r+4nsMF8J0VCvNqMhyVKl+jfZhgVvlcMGMn8EYrmAeP" crossorigin="anonymous"></script>

    <!-- js-yaml for YAML parsing (pinned version with SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" integrity="sha384-/7rq3BCpOjWxQF0nQCrWUILVLz6ZqgmAk3VIOr5dLpU1VEtX4fBfHxdF4nHVW2Ei" crossorigin="anonymous"></script>

    <!-- DOMPurify for HTML sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js" integrity="sha384-ACTjhlVTLgcKrLJBxL5bNkbxFnbYXm1mMQz8+TyoRNtDcVX3fZy2lMPT8H8RvVRH" crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, "Segoe UI", sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f5;
        }
        
        /* Focus mode styles */
        body.focus-mode {
            background: #fff;
        }
        
        body.focus-mode .editor-panel {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border: none;
            background: #fff;
        }
        
        body.focus-mode .preview-panel,
        body.focus-mode .resizer {
            display: none;
        }
        
        body.focus-mode .btn-focus {
            background: #007acc;
            border-color: #007acc;
            color: #fff;
        }
        
        .composer-container {
            display: flex;
            height: 100vh;
        }
        
        .editor-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
            background: #fff;
            transition: all 0.3s ease;
        }
        
        .editor-header {
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor-header h2 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }
        
        .editor-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            color: #333;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #333;
            color: #fff;
            border-color: #333;
        }
        
        .btn-primary:hover {
            background: #000;
        }
        
        .btn-danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .btn-danger:hover {
            background: #dc3545;
            color: #fff;
        }
        
        .btn-focus {
            background: #007acc;
            color: #fff;
            border-color: #007acc;
        }
        
        .btn-focus:hover {
            background: #005a9e;
        }
        
        .btn-ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
        }
        
        .btn-ai:hover {
            background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%);
        }
        
        .btn-ai:disabled {
            background: #ccc;
        }
        
        /* Frontmatter Section */
        .frontmatter-section {
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .frontmatter-header {
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .frontmatter-header:hover {
            background: #f0f0f0;
        }
        
        .frontmatter-header h3 {
            font-size: 0.8rem;
            font-weight: 600;
            color: #555;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .frontmatter-header h3::before {
            content: '▶';
            font-size: 0.6rem;
            transition: transform 0.2s;
        }
        
        .frontmatter-section.open .frontmatter-header h3::before {
            transform: rotate(90deg);
        }
        
        .frontmatter-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            background: #e9ecef;
            border-radius: 10px;
            color: #666;
            font-weight: normal;
        }
        
        .frontmatter-fields {
            padding: 0 1rem 0.75rem 1rem;
            display: none;
        }
        
        .frontmatter-section.open .frontmatter-fields {
            display: block;
        }
        
        .field-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            align-items: flex-end;
        }
        
        .field-row:last-child {
            margin-bottom: 0;
        }
        
        .field-group {
            flex: 1;
        }
        
        .field-group.small {
            flex: 0 0 140px;
        }
        
        .field-group.auto {
            flex: 0 0 auto;
        }
        
        .field-group label {
            display: block;
            font-size: 0.7rem;
            font-weight: 500;
            color: #666;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .field-group input[type="text"],
        .field-group input[type="url"],
        .field-group input[type="date"],
        .field-group textarea {
            width: 100%;
            padding: 0.4rem 0.5rem;
            font-size: 0.85rem;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-family: inherit;
        }
        
        .field-group textarea {
            resize: vertical;
            min-height: 60px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Monaco, monospace;
            font-size: 0.8rem;
        }
        
        .field-group input:focus,
        .field-group textarea:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .checkbox-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding-top: 1.5rem;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            color: #555;
            cursor: pointer;
            text-transform: none;
            letter-spacing: normal;
        }
        
        .checkbox-group input[type="checkbox"] {
            cursor: pointer;
        }
        
        /* Syntax Highlighted Editor */
        .editor-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #markdown-editor {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            padding: 1.5rem;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Monaco, monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            background: transparent;
            color: transparent;
            caret-color: #333;
            z-index: 2;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
        }
        
        #syntax-highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1.5rem;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Monaco, monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            pointer-events: none;
            z-index: 1;
            background: #fff;
            color: #333;
        }
        
        body.focus-mode #syntax-highlight {
            background: #fff;
            color: #333;
        }
        
        /* Syntax colors - Light mode */
        .syntax-heading { color: #0550ae; font-weight: bold; }
        .syntax-bold { color: #333; font-weight: bold; }
        .syntax-italic { color: #333; font-style: italic; }
        .syntax-link-text { color: #0550ae; }
        .syntax-link-url { color: #6e7781; }
        .syntax-code { color: #cf222e; background: #f6f8fa; border-radius: 3px; padding: 0 2px; }
        .syntax-code-block { color: #1f2328; background: #f6f8fa; display: block; }
        .syntax-code-lang { color: #8250df; background: #f6f8fa; }
        .syntax-blockquote { color: #57606a; border-left: 3px solid #d0d7de; padding-left: 8px; display: inline; }
        .syntax-list { color: #cf222e; }
        .syntax-hr { color: #d0d7de; }
        .syntax-shortcode { color: #8250df; background: #f0f7ff; border-radius: 3px; padding: 0 2px; }
        .syntax-frontmatter { color: #6e7781; background: #f6f8fa; }
        .syntax-math { color: #953800; background: #fff8e6; border-radius: 3px; padding: 0 2px; }
        
        #markdown-editor::placeholder {
            color: #999;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .composer-container {
                flex-direction: column;
                height: auto;
                overflow-y: auto;
            }
            
            .editor-panel {
                width: 100% !important;
                height: 100vh;
                min-height: 100vh;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .preview-panel {
                width: 100% !important;
                height: auto;
                min-height: 50vh;
            }
            
            .resizer {
                display: none;
            }
            
            .editor-actions {
                flex-wrap: wrap;
                gap: 0.3rem;
            }
            
            .btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.7rem;
            }
            
            .field-row {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .field-group.small {
                flex: 1;
            }
            
            .checkbox-group {
                padding-top: 0.5rem;
            }
            
            body.focus-mode .editor-panel {
                height: 100vh;
            }
        }
        
        /* Right: Preview Panel */
        .preview-panel {
            width: 50%;
            overflow-y: auto;
            background: #fff;
        }
        
        .preview-header {
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .preview-header h2 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }
        
        .preview-content {
            padding: 2rem;
            max-width: 800px;
        }
        
        /* Blog Styles */
        .post { margin-bottom: 1rem; padding-bottom: 1rem; }
        .post-title { margin-bottom: 0.5rem; line-height: 1.3; font-size: 1.5rem; font-weight: 600; color: #333; }
        .post-meta { font-size: 0.85rem; color: #595959; margin-bottom: 1rem; }
        .post-meta a { color: #007acc; text-decoration: none; }
        .post-content { line-height: 1.7; color: #333; }
        .post-content p { margin-bottom: 1rem; }
        .post-content a { color: #007acc; text-decoration: none; }
        .post-content a:hover { text-decoration: underline; }
        .post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6 { margin: 1.5rem 0 1rem 0; line-height: 1.3; color: #333; }
        .post-content h1 { font-size: 1.75rem; }
        .post-content h2 { font-size: 1.5rem; }
        .post-content h3 { font-size: 1.25rem; }
        .post-content h4 { font-size: 1.1rem; }
        .post-content ul, .post-content ol { margin: 1rem 0; padding-left: 1.5rem; }
        .post-content li { margin-bottom: 0.5rem; }
        blockquote { margin: 1em 0; padding-left: 1em; border-left: 2px solid #aaa; color: #595959; }
        blockquote p { margin: 0.5em 0; }
        .post-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .post-content th, .post-content td { padding: 0.5rem; border: 1px solid #ddd; text-align: left; }
        .post-content th { background: #f6f8fa; font-weight: 600; }
        code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Monaco, monospace; font-size: 0.875rem; line-height: 1.5; }
        p code, li code, td code { background-color: #f6f8fa; padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.875em; color: #24292f; }
        pre { background-color: #f6f8fa; border-radius: 6px; padding: 1rem; margin: 1rem 0; overflow-x: auto; }
        pre code { background: none; padding: 0; font-size: 0.875rem; }
        .post-content img { max-width: 100%; height: auto; display: block; margin: 1rem auto; border-radius: 4px; }
        .img-container { display: block; margin: 0 auto; padding: 1rem 0; }
        .img-container img { width: 100%; height: auto; display: block; cursor: pointer; transition: opacity 0.2s; }
        .img-container img:hover { opacity: 0.9; }
        .table-container { width: 100%; overflow-x: auto; margin: 2rem 0; }
        .table-container iframe { width: 100%; border: none; background: transparent; }
        .inline-newsletter { margin: 2.5rem auto; padding: 0.5rem 0 0.5rem 1.5rem; border-left: 2px solid #333; width: 80%; }
        .inline-newsletter-headline { font-family: Georgia, "Times New Roman", serif; font-size: 1.5rem; font-style: italic; font-weight: 400; line-height: 1.4; color: #333; margin: 0 0 1.25rem 0; }
        .inline-newsletter-form { display: flex; gap: 0; max-width: 90%; }
        .inline-newsletter-input { flex: 1; padding: 0.75rem 1rem; font-size: 1rem; border: 1px solid #333; border-right: none; background: #fff; }
        .inline-newsletter-button { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; background: #333; color: #fff; border: 1px solid #333; cursor: pointer; }
        .inline-newsletter-privacy { margin: 0.75rem 0 0 0; font-size: 0.8rem; color: #666; }
        hr { border: none; border-top: 1px solid #e9ecef; margin: 2rem 0; }
        .katex-display { margin: 1rem 0; overflow-x: auto; }
        .disclaimer { margin: 2rem 0; padding: 0.75rem 1rem; border-left: 3px solid #656d76; background: #f6f8fa; }
        .disclaimer p { margin: 0; font-size: 0.8rem; line-height: 1.5; color: #656d76; }
        .disclaimer a { color: #007acc; }
        .feedback-footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e9ecef; text-align: center; color: #595959; font-size: 0.9rem; }
        .feedback-footer p { margin: 0; line-height: 1.6; }
        .feedback-footer a { color: #007acc; text-decoration: none; }
        
        /* Status bar */
        .status-bar {
            padding: 0.4rem 1rem;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 0.75rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        /* Resizer */
        .resizer {
            width: 4px;
            background: #e0e0e0;
            cursor: col-resize;
            flex-shrink: 0;
        }
        
        .resizer:hover {
            background: #007acc;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="composer-container">
        <div class="editor-panel">
            <div class="editor-header">
                <h2>Post Composer</h2>
                <div class="editor-actions">
                    <button class="btn btn-focus" onclick="toggleFocusMode()" id="focus-btn">Focus</button>
                    <button class="btn" onclick="insertShortcode('img')">+ Image</button>
                    <button class="btn" onclick="insertShortcode('table')">+ Table</button>
                    <button class="btn" onclick="insertShortcode('newsletter')">+ Newsletter</button>
                    <button class="btn" onclick="insertShortcode('disclaimer')">+ Disclaimer</button>
                    <button class="btn btn-ai" onclick="generateSEO()" id="seo-btn">✨ Auto SEO</button>
                    <button class="btn btn-primary" onclick="copyMarkdown()">Copy</button>
                    <button class="btn btn-primary" onclick="downloadMarkdown()">Download</button>
                    <button class="btn btn-danger" onclick="clearAll()">Clear</button>
                </div>
            </div>
            
            <div class="frontmatter-section open" id="essential-section">
                <div class="frontmatter-header" onclick="toggleSection('essential-section')">
                    <h3>Essential</h3>
                </div>
                <div class="frontmatter-fields">
                    <div class="field-row">
                        <div class="field-group">
                            <label for="post-title">Title</label>
                            <input type="text" id="post-title" placeholder="Post title" oninput="onFieldChange()">
                        </div>
                        <div class="field-group small">
                            <label for="post-date">Date</label>
                            <input type="date" id="post-date" oninput="onFieldChange()">
                        </div>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="post-draft" onchange="onFieldChange()"> Draft</label>
                            <label><input type="checkbox" id="post-math" onchange="onFieldChange()"> Math</label>
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field-group">
                            <label for="post-categories">Categories</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="cat-finance" onchange="onFieldChange()"> Finance</label>
                                <label><input type="checkbox" id="cat-ai" onchange="onFieldChange()"> AI</label>
                                <label><input type="checkbox" id="cat-tech" onchange="onFieldChange()"> Tech</label>
                                <label><input type="checkbox" id="cat-medicine" onchange="onFieldChange()"> Medicine</label>
                                <label><input type="checkbox" id="cat-economics" onchange="onFieldChange()"> Economics</label>
                            </div>
                        </div>
                        <div class="field-group">
                            <label for="post-type">Type</label>
                            <select id="post-type" onchange="onFieldChange()">
                                <option value="">Select type...</option>
                                <option value="Commentary">Commentary</option>
                                <option value="Essay">Essay</option>
                                <option value="Project">Project</option>
                                <option value="Review">Review</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="frontmatter-section" id="seo-section">
                <div class="frontmatter-header" onclick="toggleSection('seo-section')">
                    <h3>SEO & Metadata <span class="frontmatter-badge" id="seo-badge">0 fields</span></h3>
                </div>
                <div class="frontmatter-fields">
                    <div class="field-row">
                        <div class="field-group">
                            <label for="post-description">Description</label>
                            <input type="text" id="post-description" placeholder="Meta description for SEO" oninput="onFieldChange()">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field-group">
                            <label for="post-keywords">Keywords (comma-separated)</label>
                            <input type="text" id="post-keywords" placeholder="keyword1, keyword2, keyword3" oninput="onFieldChange()">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field-group">
                            <label for="post-images">OG Image URL</label>
                            <input type="url" id="post-images" placeholder="https://static.philippdubach.com/ograph/..." oninput="onFieldChange()">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="frontmatter-section" id="advanced-section">
                <div class="frontmatter-header" onclick="toggleSection('advanced-section')">
                    <h3>Advanced <span class="frontmatter-badge" id="advanced-badge">0 fields</span></h3>
                </div>
                <div class="frontmatter-fields">
                    <div class="field-row">
                        <div class="field-group">
                            <label for="post-external">External URL (via link)</label>
                            <input type="url" id="post-external" placeholder="https://..." oninput="onFieldChange()">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field-group">
                            <label for="post-aliases">Aliases (one per line)</label>
                            <textarea id="post-aliases" placeholder="/2025/12/02/post-slug/" oninput="onFieldChange()"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="editor-wrapper">
                <div id="syntax-highlight"></div>
                <textarea id="markdown-editor" placeholder="Write your post content here...

Paste a complete Hugo post with frontmatter (---) and it will be parsed automatically.

> This is a blockquote

Regular paragraph with **bold** and *italic* text.

## Heading

- List item 1  
- List item 2

`inline code`

```python
def hello():
    print('Hello!')
```
"></textarea>
            </div>
            
            <div class="status-bar">
                <span id="word-count">0 words</span>
                <span id="reading-time">0 min read</span>
            </div>
        </div>
        
        <div class="resizer" id="resizer"></div>
        
        <div class="preview-panel">
            <div class="preview-header">
                <h2>Preview</h2>
            </div>
            <div class="preview-content">
                <article class="post single">
                    <header class="post-header">
                        <h1 class="post-title" id="preview-title">Untitled Post</h1>
                        <div class="post-meta" id="preview-meta">
                            <time id="preview-date">January 7, 2026</time>
                            • <span id="preview-words">0</span> words
                            • <span id="preview-reading">0</span> min read
                            <span id="preview-external"></span>
                            • <a href="#" title="Copy short link">∞</a>
                        </div>
                    </header>
                    <div class="post-content" id="preview-content">
                        <p>Start writing to see your preview...</p>
                    </div>
                </article>
                <nav class="footer-links" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e9ecef; font-size: 0.85rem;">
                    <a href="https://philippdubach.com/subscribe/">Newsletter</a>
                    <span style="color: #ccc; margin: 0 0.5rem;">·</span>
                    <a href="https://github.com/philippdubach" target="_blank" rel="noopener noreferrer">GitHub</a>
                    <span style="color: #ccc; margin: 0 0.5rem;">·</span>
                    <a href="https://bsky.app/profile/philippdubach.com" target="_blank" rel="noopener noreferrer">Bluesky</a>
                    <span style="color: #ccc; margin: 0 0.5rem;">·</span>
                    <a href="mailto:me@philippdubach.com">Email</a>
                </nav>
                <p class="copyright" style="margin-top: 0.5rem; font-size: 0.8rem; color: #999; text-align: center;">© 2026 Philipp Dubach</p>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        // DOM Element Cache (performance optimization)
        const DOM = {
            editor: null,
            syntaxHighlight: null,
            previewTitle: null,
            previewDate: null,
            previewContent: null,
            previewExternal: null,
            previewWords: null,
            previewReading: null,
            wordCount: null,
            readingTime: null,
            focusBtn: null,
            seoBtn: null,
            toast: null,
            seoBadge: null,
            advancedBadge: null
        };
        
        // Initialize DOM cache
        function initDOMCache() {
            DOM.editor = document.getElementById('markdown-editor');
            DOM.syntaxHighlight = document.getElementById('syntax-highlight');
            DOM.previewTitle = document.getElementById('preview-title');
            DOM.previewDate = document.getElementById('preview-date');
            DOM.previewContent = document.getElementById('preview-content');
            DOM.previewExternal = document.getElementById('preview-external');
            DOM.previewWords = document.getElementById('preview-words');
            DOM.previewReading = document.getElementById('preview-reading');
            DOM.wordCount = document.getElementById('word-count');
            DOM.readingTime = document.getElementById('reading-time');
            DOM.focusBtn = document.getElementById('focus-btn');
            DOM.seoBtn = document.getElementById('seo-btn');
            DOM.toast = document.getElementById('toast');
            DOM.seoBadge = document.getElementById('seo-badge');
            DOM.advancedBadge = document.getElementById('advanced-badge');
        }
        
        // Sanitize text for safe HTML display (XSS prevention)
        function sanitizeText(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // State
        let frontmatter = { title: '', date: '', description: '', keywords: [], images: [], external_url: '', aliases: [], draft: false, math: false, categories: [], type: '' };
        let bodyContent = '';
        let isUpdatingFromPaste = false;
        let isFocusMode = false;
        
        // Configure marked
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try { return hljs.highlight(code, { language: lang }).value; } catch (e) {}
                }
                return hljs.highlightAuto(code).value;
            }
        });
        
        const STATIC_BASE = 'https://static.philippdubach.com';
        
        // Syntax highlighting for editor
        function highlightSyntax(text) {
            if (!text) return '';
            
            let html = escapeHtml(text);
            
            // Code blocks (must be first)
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (m, lang, code) => {
                return `<span class="syntax-code-block">\`\`\`<span class="syntax-code-lang">${lang}</span>\n${code}\`\`\`</span>`;
            });
            
            // Inline code
            html = html.replace(/`([^`\n]+)`/g, '<span class="syntax-code">`$1`</span>');
            
            // Headings
            html = html.replace(/^(#{1,6}\s.*)$/gm, '<span class="syntax-heading">$1</span>');
            
            // Bold
            html = html.replace(/\*\*([^*]+)\*\*/g, '<span class="syntax-bold">**$1**</span>');
            
            // Italic
            html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<span class="syntax-italic">*$1*</span>');
            
            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<span class="syntax-link-text">[$1]</span>(<span class="syntax-link-url">$2</span>)');
            
            // Blockquotes
            html = html.replace(/^(&gt;\s?.*)$/gm, '<span class="syntax-blockquote">$1</span>');
            
            // Lists
            html = html.replace(/^(\s*[-*+]\s)/gm, '<span class="syntax-list">$1</span>');
            html = html.replace(/^(\s*\d+\.\s)/gm, '<span class="syntax-list">$1</span>');
            
            // Horizontal rule
            html = html.replace(/^(---+|___+|\*\*\*+)$/gm, '<span class="syntax-hr">$1</span>');
            
            // Shortcodes
            html = html.replace(/(\{\{&lt;[^&]*&gt;\}\})/g, '<span class="syntax-shortcode">$1</span>');
            
            // Math
            html = html.replace(/\$\$[\s\S]*?\$\$/g, m => `<span class="syntax-math">${m}</span>`);
            html = html.replace(/(?<!\$)\$(?!\$)([^$\n]+)\$(?!\$)/g, '<span class="syntax-math">$$$1$$</span>');
            
            return html;
        }
        
        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
        
        let syntaxHighlightPending = false;
        
        function updateSyntaxHighlight() {
            if (syntaxHighlightPending) return;
            syntaxHighlightPending = true;
            
            requestAnimationFrame(() => {
                DOM.syntaxHighlight.innerHTML = highlightSyntax(DOM.editor.value) + '\n';
                DOM.syntaxHighlight.scrollTop = DOM.editor.scrollTop;
                syntaxHighlightPending = false;
            });
        }
        
        // Sync scroll (initialized after DOM cache)
        function initScrollSync() {
            DOM.editor.addEventListener('scroll', function() {
                DOM.syntaxHighlight.scrollTop = this.scrollTop;
            });
        }
        
        // Focus mode
        function toggleFocusMode() {
            isFocusMode = !isFocusMode;
            document.body.classList.toggle('focus-mode', isFocusMode);
            DOM.focusBtn.textContent = isFocusMode ? 'Exit Focus' : 'Focus';
        }
        
        // Frontmatter parsing
        function parseFrontmatter(text) {
            const match = text.match(/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/);
            if (!match) return { frontmatter: null, body: text };
            try {
                return { frontmatter: jsyaml.load(match[1]), body: match[2] };
            } catch (e) {
                return { frontmatter: null, body: text };
            }
        }
        
        function generateFrontmatterYaml() {
            let lines = ['---'];
            if (frontmatter.title) lines.push(`title: ${frontmatter.title}`);
            if (frontmatter.date) lines.push(`date: ${frontmatter.date}`);
            
            if (frontmatter.images && frontmatter.images.length > 0) {
                lines.push('images:');
                frontmatter.images.forEach(img => lines.push(`- ${img}`));
            } else {
                lines.push('images:');
                lines.push('- https://static.philippdubach.com/ograph/ograph-post.jpg');
            }
            
            if (frontmatter.description) {
                const desc = frontmatter.description;
                if (desc.includes(':') || desc.includes("'") || desc.includes('"')) {
                    lines.push(`description: '${desc.replace(/'/g, "''")}'`);
                } else {
                    lines.push(`description: ${desc}`);
                }
            }
            
            if (frontmatter.keywords && frontmatter.keywords.length > 0) {
                lines.push('keywords:');
                frontmatter.keywords.forEach(kw => lines.push(`- ${kw.trim()}`));
            }
            
            if (frontmatter.external_url) lines.push(`external_url: ${frontmatter.external_url}`);
            
            if (frontmatter.categories && frontmatter.categories.length > 0) {
                lines.push('categories:');
                frontmatter.categories.forEach(cat => lines.push(`- ${cat}`));
            }
            
            if (frontmatter.type) lines.push(`type: ${frontmatter.type}`);
            
            if (frontmatter.math) lines.push('math: true');
            lines.push(`draft: ${frontmatter.draft ? 'true' : 'false'}`);
            
            if (frontmatter.aliases && frontmatter.aliases.length > 0) {
                lines.push('aliases:');
                frontmatter.aliases.forEach(alias => { if (alias.trim()) lines.push(`- ${alias.trim()}`); });
            }
            
            lines.push('---', '');
            return lines.join('\n');
        }
        
        // UI sync
        function syncFieldsFromFrontmatter() {
            document.getElementById('post-title').value = frontmatter.title || '';
            document.getElementById('post-date').value = frontmatter.date || '';
            document.getElementById('post-description').value = frontmatter.description || '';
            document.getElementById('post-keywords').value = (frontmatter.keywords || []).join(', ');
            document.getElementById('post-images').value = (frontmatter.images || [])[0] || '';
            document.getElementById('post-external').value = frontmatter.external_url || '';
            document.getElementById('post-aliases').value = (frontmatter.aliases || []).join('\n');
            document.getElementById('post-draft').checked = frontmatter.draft || false;
            document.getElementById('post-math').checked = frontmatter.math || false;
            
            // Categories
            const cats = frontmatter.categories || [];
            document.getElementById('cat-finance').checked = cats.includes('Finance');
            document.getElementById('cat-ai').checked = cats.includes('AI');
            document.getElementById('cat-tech').checked = cats.includes('Tech');
            document.getElementById('cat-medicine').checked = cats.includes('Medicine');
            document.getElementById('cat-economics').checked = cats.includes('Economics');
            
            // Type
            document.getElementById('post-type').value = frontmatter.type || '';
            
            updateBadges();
        }
        
        function syncFrontmatterFromFields() {
            frontmatter.title = document.getElementById('post-title').value;
            frontmatter.date = document.getElementById('post-date').value;
            frontmatter.description = document.getElementById('post-description').value;
            const kw = document.getElementById('post-keywords').value;
            frontmatter.keywords = kw ? kw.split(',').map(k => k.trim()).filter(k => k) : [];
            const img = document.getElementById('post-images').value;
            frontmatter.images = img ? [img] : [];
            frontmatter.external_url = document.getElementById('post-external').value;
            const al = document.getElementById('post-aliases').value;
            frontmatter.aliases = al ? al.split('\n').map(a => a.trim()).filter(a => a) : [];
            frontmatter.draft = document.getElementById('post-draft').checked;
            frontmatter.math = document.getElementById('post-math').checked;
            
            // Categories
            frontmatter.categories = [];
            if (document.getElementById('cat-finance').checked) frontmatter.categories.push('Finance');
            if (document.getElementById('cat-ai').checked) frontmatter.categories.push('AI');
            if (document.getElementById('cat-tech').checked) frontmatter.categories.push('Tech');
            if (document.getElementById('cat-medicine').checked) frontmatter.categories.push('Medicine');
            if (document.getElementById('cat-economics').checked) frontmatter.categories.push('Economics');
            
            // Type
            frontmatter.type = document.getElementById('post-type').value;
            
            updateBadges();
        }
        
        function updateBadges() {
            let seoCount = 0;
            if (frontmatter.description) seoCount++;
            if (frontmatter.keywords && frontmatter.keywords.length > 0) seoCount++;
            if (frontmatter.images && frontmatter.images.length > 0) seoCount++;
            DOM.seoBadge.textContent = `${seoCount} field${seoCount !== 1 ? 's' : ''}`;
            
            let advCount = 0;
            if (frontmatter.external_url) advCount++;
            if (frontmatter.aliases && frontmatter.aliases.length > 0) advCount++;
            DOM.advancedBadge.textContent = `${advCount} field${advCount !== 1 ? 's' : ''}`;
        }
        
        // Event handlers
        function onFieldChange() {
            syncFrontmatterFromFields();
            updatePreview();
            saveToLocalStorage();
        }
        
        function onEditorInput() {
            const text = DOM.editor.value;
            const parsed = parseFrontmatter(text);
            
            if (parsed.frontmatter) {
                frontmatter = {
                    title: parsed.frontmatter.title || '',
                    date: parsed.frontmatter.date || '',
                    description: parsed.frontmatter.description || '',
                    keywords: parsed.frontmatter.keywords || [],
                    images: parsed.frontmatter.images || [],
                    external_url: parsed.frontmatter.external_url || '',
                    aliases: parsed.frontmatter.aliases || [],
                    draft: parsed.frontmatter.draft || false,
                    math: parsed.frontmatter.math || false,
                    categories: parsed.frontmatter.categories || [],
                    type: parsed.frontmatter.type || ''
                };
                
                if (frontmatter.date instanceof Date) {
                    frontmatter.date = frontmatter.date.toISOString().split('T')[0];
                } else if (typeof frontmatter.date === 'string' && frontmatter.date.includes('T')) {
                    frontmatter.date = frontmatter.date.split('T')[0];
                }
                
                bodyContent = parsed.body;
                syncFieldsFromFrontmatter();
                
                if (!isUpdatingFromPaste) {
                    isUpdatingFromPaste = true;
                    DOM.editor.value = bodyContent;
                    isUpdatingFromPaste = false;
                }
            } else {
                bodyContent = text;
            }
            
            updateSyntaxHighlight();
            updatePreview();
            saveToLocalStorage();
        }
        
        // Shortcodes
        function processShortcodes(text) {
            text = text.replace(/\{\{<\s*img\s+([^>]+)\s*>\}\}/g, (match, attrs) => {
                const src = attrs.match(/src=["']([^"']+)["']/)?.[1] || '';
                const alt = attrs.match(/alt=["']([^"']+)["']/)?.[1] || '';
                const width = attrs.match(/width=["']([^"']+)["']/)?.[1] || '80%';
                const imgUrl = src.startsWith('http') ? src : `${STATIC_BASE}/${src}`;
                return `<div class="img-container" style="width: ${width}; margin: 0 auto;"><img src="${imgUrl}" alt="${alt}" loading="lazy"></div>`;
            });
            
            text = text.replace(/\{\{<\s*table\s+([^>]+)\s*>\}\}/g, (match, attrs) => {
                const src = attrs.match(/src=["']([^"']+)["']/)?.[1] || '';
                const height = attrs.match(/height=["']([^"']+)["']/)?.[1] || '800px';
                return `<div class="table-container"><iframe src="${STATIC_BASE}/html/${src}" style="width: 100%; height: ${height}; border: none;" loading="lazy"></iframe></div>`;
            });
            
            text = text.replace(/\{\{<\s*newsletter\s*>\}\}/g, () => {
                return `<aside class="inline-newsletter"><div class="inline-newsletter-content"><p class="inline-newsletter-headline">Enjoy this writing? Get new posts, projects, and articles delivered monthly.</p><form class="inline-newsletter-form"><input type="email" placeholder="your@email.com" class="inline-newsletter-input" disabled><button type="button" class="inline-newsletter-button" disabled>Sign Up</button></form><p class="inline-newsletter-privacy">No tracking. Unsubscribe anytime.</p></div></aside>`;
            });
            
            // Disclaimer shortcode with multiple types
            text = text.replace(/\{\{<\s*disclaimer\s*(?:type=["']([^"']+)["'])?\s*>\}\}/g, (match, type) => {
                const disclaimerType = type || 'finance';
                const disclaimers = {
                    finance: '<strong>Disclaimer:</strong> Personal opinions only, not professional advice. I write here in a private capacity, not as a financial professional. This is not investment, financial, tax, or legal advice. Past performance does not indicate future results. Do your own research and consult qualified professionals before making financial decisions. No liability accepted for any losses.',
                    medical: '<strong>Disclaimer:</strong> For informational purposes only, not medical advice. Consult a qualified healthcare provider for any medical questions or conditions.',
                    general: '<strong>Disclaimer:</strong> Personal views only. Information may be incomplete or outdated. No warranties given. Use at your own risk.',
                    ai: '<strong>Disclaimer:</strong> AI capabilities evolve rapidly; information may become outdated. Code and implementations provided as-is without warranty.',
                    research: '<strong>Disclaimer:</strong> Summarizes third-party research. No affiliation with cited researchers. Interpretations are my own and may differ from original authors\' views.',
                    gambling: '<strong>Disclaimer:</strong> For informational purposes only, not financial or legal advice. Gambling involves significant risk of loss. You are responsible for compliance with your local laws and age restrictions. Gamble responsibly. Support: <a href="https://www.gambleaware.org" target="_blank" rel="noopener">BeGambleAware.org</a>, <a href="https://gamblersanonymous.org" target="_blank" rel="noopener">Gamblers Anonymous</a>.'
                };
                const text = disclaimers[disclaimerType] || disclaimers.finance;
                return `<aside class="disclaimer" role="note" aria-label="Disclaimer"><div class="disclaimer-content"><p>${text}</p></div></aside>`;
            });
            
            return text;
        }
        
        function insertShortcode(type) {
            const start = DOM.editor.selectionStart;
            let shortcode = '';
            if (type === 'img') shortcode = '{{< img src="path/to/image.jpg" alt="Description" width="80%" >}}';
            else if (type === 'table') shortcode = '{{< table src="table.html" height="600px" >}}';
            else if (type === 'newsletter') shortcode = '{{< newsletter >}}';
            else if (type === 'disclaimer') shortcode = '{{< disclaimer type="finance" >}}';
            
            DOM.editor.value = DOM.editor.value.substring(0, start) + shortcode + DOM.editor.value.substring(DOM.editor.selectionEnd);
            DOM.editor.selectionStart = DOM.editor.selectionEnd = start + shortcode.length;
            DOM.editor.focus();
            bodyContent = DOM.editor.value;
            updateSyntaxHighlight();
            updatePreview();
            saveToLocalStorage();
        }
        
        // Preview
        function getStats(text) {
            const clean = text.replace(/\{\{<[^>]+>\}\}/g, '').replace(/```[\s\S]*?```/g, '').replace(/`[^`]+`/g, '').replace(/\[([^\]]+)\]\([^)]+\)/g, '$1').replace(/[#*_~]/g, '').trim();
            const words = clean.split(/\s+/).filter(w => w.length > 0).length;
            return { words, readingTime: Math.max(1, Math.ceil(words / 200)) };
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            return new Date(dateStr + 'T12:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
        
        const updatePreview = debounce(function() {
            const rawHtml = marked.parse(processShortcodes(bodyContent));
            // Sanitize HTML with DOMPurify to prevent XSS
            const html = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(rawHtml, {
                ADD_TAGS: ['iframe'],
                ADD_ATTR: ['loading', 'sandbox', 'allow', 'allowfullscreen'],
                ALLOW_DATA_ATTR: false
            }) : rawHtml;
            // Use textContent for title to prevent XSS
            DOM.previewTitle.textContent = frontmatter.title || 'Untitled Post';
            DOM.previewDate.textContent = formatDate(frontmatter.date);
            DOM.previewContent.innerHTML = html;

            // Validate and display external URL safely
            if (frontmatter.external_url) {
                try {
                    const url = new URL(frontmatter.external_url);
                    // Only allow http/https protocols
                    if (url.protocol === 'http:' || url.protocol === 'https:') {
                        const safeUrl = sanitizeText(frontmatter.external_url);
                        DOM.previewExternal.innerHTML = ` • <a href="${safeUrl}" target="_blank" rel="noopener noreferrer">via</a>`;
                    } else {
                        DOM.previewExternal.textContent = '';
                    }
                } catch {
                    DOM.previewExternal.textContent = '';
                }
            } else {
                DOM.previewExternal.textContent = '';
            }
            
            const stats = getStats(bodyContent);
            DOM.previewWords.textContent = stats.words;
            DOM.previewReading.textContent = stats.readingTime;
            DOM.wordCount.textContent = `${stats.words} words`;
            DOM.readingTime.textContent = `${stats.readingTime} min read`;
            
            if (frontmatter.math && typeof renderMathInElement === 'function') {
                renderMathInElement(DOM.previewContent, {
                    delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\[', right: '\\]', display: true}, {left: '\\(', right: '\\)', display: false}],
                    throwOnError: false
                });
            }
            
            DOM.previewContent.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        }, 100);
        
        // Auto SEO Generation
        async function generateSEO() {
            const originalText = DOM.seoBtn.innerHTML;
            
            if (bodyContent.trim().length < 50) {
                showToast('Write more content first (at least 50 characters)');
                return;
            }
            
            DOM.seoBtn.disabled = true;
            DOM.seoBtn.innerHTML = '<span class="spinner"></span>Generating...';
            
            try {
                const response = await fetch('/generate-seo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: frontmatter.title || 'Untitled',
                        content: bodyContent
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to generate SEO');
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update fields
                if (data.title && !frontmatter.title) {
                    frontmatter.title = data.title;
                }
                if (data.description) {
                    frontmatter.description = data.description;
                }
                if (data.keywords && Array.isArray(data.keywords)) {
                    frontmatter.keywords = data.keywords;
                }
                
                syncFieldsFromFrontmatter();
                updatePreview();
                saveToLocalStorage();
                
                // Open SEO section
                document.getElementById('seo-section').classList.add('open');
                
                showToast('SEO metadata generated!');
            } catch (error) {
                console.error('SEO generation error:', error);
                showToast('Failed to generate SEO: ' + error.message);
            } finally {
                DOM.seoBtn.disabled = false;
                DOM.seoBtn.innerHTML = originalText;
            }
        }
        
        // Actions
        function copyMarkdown() {
            navigator.clipboard.writeText(generateFrontmatterYaml() + bodyContent).then(() => showToast('Copied to clipboard!'));
        }
        
        function downloadMarkdown() {
            const title = frontmatter.title || 'untitled';
            const date = frontmatter.date || new Date().toISOString().split('T')[0];
            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
            const filename = `${date.replace(/-/g, '')}-${slug || 'post'}.md`;
            
            const blob = new Blob([generateFrontmatterYaml() + bodyContent], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
            showToast(`Downloaded ${filename}`);
        }
        
        function clearAll() {
            if (!confirm('Clear all content?')) return;
            frontmatter = { title: '', date: new Date().toISOString().split('T')[0], description: '', keywords: [], images: [], external_url: '', aliases: [], draft: false, math: false };
            bodyContent = '';
            syncFieldsFromFrontmatter();
            DOM.editor.value = '';
            updateSyntaxHighlight();
            updatePreview();
            try {
                localStorage.removeItem('composer-draft');
            } catch (e) {
                console.warn('localStorage unavailable:', e);
            }
            showToast('Cleared!');
        }
        
        function toggleSection(id) { document.getElementById(id).classList.toggle('open'); }
        
        function showToast(msg) {
            DOM.toast.textContent = msg;
            DOM.toast.classList.add('show');
            setTimeout(() => DOM.toast.classList.remove('show'), 2000);
        }
        
        // Storage with error handling
        function saveToLocalStorage() {
            try {
                localStorage.setItem('composer-draft', JSON.stringify({ frontmatter, body: bodyContent }));
            } catch (e) {
                console.warn('Failed to save to localStorage:', e);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('composer-draft');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.frontmatter) frontmatter = { ...frontmatter, ...data.frontmatter };
                    bodyContent = data.body || '';
                    syncFieldsFromFrontmatter();
                    DOM.editor.value = bodyContent;
                }
            } catch (e) {
                console.warn('Failed to load from localStorage:', e);
            }
        }
        
        // Resizer
        let isResizing = false;
        
        function initResizer() {
            document.getElementById('resizer').addEventListener('mousedown', () => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });
        }
        
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const w = (e.clientX / document.querySelector('.composer-container').offsetWidth) * 100;
            if (w >= 20 && w <= 80) {
                document.querySelector('.editor-panel').style.width = `${w}%`;
                document.querySelector('.preview-panel').style.width = `${100 - w}%`;
            }
        });
        
        document.addEventListener('mouseup', () => {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        });
        
        // Auto-closing brackets
        function handleAutoBracket(e) {
            const brackets = { '[': ']', '(': ')', '{': '}' };
            if (brackets[e.key]) {
                e.preventDefault();
                const start = DOM.editor.selectionStart;
                const end = DOM.editor.selectionEnd;
                const text = DOM.editor.value;
                const selected = text.substring(start, end);
                DOM.editor.value = text.substring(0, start) + e.key + selected + brackets[e.key] + text.substring(end);
                DOM.editor.selectionStart = DOM.editor.selectionEnd = start + 1;
                bodyContent = DOM.editor.value;
                updateSyntaxHighlight();
                updatePreview();
                saveToLocalStorage();
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.metaKey || e.ctrlKey) {
                if (e.key === 's') { e.preventDefault(); downloadMarkdown(); }
                else if (e.key === 'e') { e.preventDefault(); copyMarkdown(); }
            }
            if (e.key === 'Escape' && isFocusMode) toggleFocusMode();
        });
        
        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize DOM cache first
            initDOMCache();
            initScrollSync();
            initResizer();
            
            frontmatter.date = new Date().toISOString().split('T')[0];
            loadFromLocalStorage();
            syncFieldsFromFrontmatter();
            
            DOM.editor.addEventListener('input', onEditorInput);
            DOM.editor.addEventListener('paste', () => setTimeout(onEditorInput, 0));
            DOM.editor.addEventListener('keydown', handleAutoBracket);
            
            updateSyntaxHighlight();
            updatePreview();
        });
    </script>
</body>
</html>
