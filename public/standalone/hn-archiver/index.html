<!doctype html><html lang=en-us><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=Content-Security-Policy content="default-src 'self'; script-src 'self' 'unsafe-inline' https://gc.zgo.at https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://philippdubach.goatcounter.com https://weekly-top-goatcounter-api.philippd.workers.dev https://newsletter-api.philippd.workers.dev https://gc.zgo.at https://pdub.click; frame-ancestors 'self'; base-uri 'self';"><link rel=preconnect href=https://gc.zgo.at crossorigin><link rel=preconnect href=https://static.philippdubach.com crossorigin><link rel=preconnect href=https://pdub.click crossorigin><link rel=preconnect href=https://newsletter-api.philippd.workers.dev crossorigin><link rel=dns-prefetch href=https://gc.zgo.at><link rel=dns-prefetch href=https://static.philippdubach.com><link rel=dns-prefetch href=https://pdub.click><link rel=dns-prefetch href=https://newsletter-api.philippd.workers.dev><meta name=robots content="index, follow"><title>Building a Serverless Hacker News Archive - philippdubach.com</title><meta name=description content="A deep dive into building a serverless Hacker News archiver using Cloudflare Workers, D1, Workers AI for topic classification, and Vectorize for semantic search. Architecture patterns for real-time data collection at scale."><meta name=keywords content="Cloudflare Workers,D1 database,Workers AI,Vectorize,serverless architecture,real-time archiving,Hacker News API,TypeScript,cron jobs,embeddings,semantic search,data engineering"><meta name=author content="Philipp Dubach"><meta name=generator content="Hugo 0.149.0"><link rel=canonical href=http://localhost:1313/standalone/hn-archiver/><style>*{margin:0;padding:0;box-sizing:border-box}.visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}.skip-link{position:absolute;top:-100%;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:.75rem 1.5rem;text-decoration:none;font-weight:500;z-index:10000;border-radius:0 0 4px 4px;transition:top .2s ease-in-out}.skip-link:focus{top:0;outline:2px solid #007acc;outline-offset:2px}a:focus-visible,button:focus-visible,input:focus-visible,textarea:focus-visible,select:focus-visible{outline:2px solid #007acc;outline-offset:2px}.post-content a:focus-visible,.archive-title a:focus-visible,.navigation a:focus-visible{outline:2px solid #007acc;outline-offset:2px;background-color:#e6f3ff}body{font-family:helvetica neue,Helvetica,Arial,segoe ui,sans-serif;padding-top:90px;line-height:1.6;color:#333;background-color:#ffff}blockquote{margin:1em 0;padding-left:1em;border-left:2px solid #aaa;color:#595959}blockquote p{margin:.5em 0}.container{display:flex;max-width:1200px;margin:0 auto;min-height:100vh}.sidebar{width:200px;min-width:200px;flex-shrink:0;background-color:#ffff;padding:1.5rem;border-right:0 solid #e9ecef;position:sticky;top:0;height:100vh;overflow-y:auto}.site-title a{text-decoration:none;color:#333;font-size:1.5rem;font-weight:700}.site-description{color:#595959;margin:.5rem 0 2rem;font-size:.9rem}.navigation ul{list-style:none;margin-bottom:2rem}.navigation li{margin-bottom:.5rem}.navigation a{text-decoration:none;color:#007acc;font-weight:500}.navigation a:hover{text-decoration:underline}.social-links a{display:inline-block;margin-right:1rem;color:#595959;text-decoration:none;font-size:.9rem}.social-links a:hover{color:#007acc}.content{flex:1;padding:2rem;padding-bottom:3rem;max-width:800px}.posts{max-width:90%}.post{margin-bottom:1rem;padding-bottom:1rem}.post:last-child{border-bottom:none}.post-title{margin-bottom:.5rem;line-height:1.3}.post-title a{text-decoration:none;color:#333;font-size:1.25rem;font-weight:600;line-height:1.3}.post-title a:hover{color:#007acc}.post-meta{font-size:.85rem;color:#595959;margin-bottom:0}.post-meta a{color:#007acc;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-content{line-height:1.7}.post-content p{margin-bottom:1rem}.post-content p:last-child{margin-bottom:.5rem}.post-content a{color:#007acc;text-decoration:none}.post-content a:hover{text-decoration:underline}.project-tag{background-color:#e9ecef;color:#495057;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:500;text-transform:uppercase;letter-spacing:.3px;margin-left:6px;display:inline-block;vertical-align:middle;border:1px solid #dee2e6}.archive{max-width:90%}.year h2{margin:2rem 0 1rem;color:#333;font-size:1.5rem}.archive-item{display:flex;margin-bottom:.75rem;align-items:baseline}.archive-meta{width:60px;flex-shrink:0;font-size:.85rem;color:#595959}.archive-title{flex:1}.archive-title a{text-decoration:none;color:#333}.archive-title a:hover{color:#007acc}@supports(text-wrap:balance){.archive-title{text-wrap:balance}}.single .post-title{font-size:1.5rem;margin-bottom:1rem;line-height:1.3}.pagination{margin-top:2rem;margin-bottom:1rem;text-align:center;padding-top:2rem;padding-bottom:1rem;border-top:1px solid #e9ecef}.pagination a{color:#007acc;text-decoration:none;font-weight:500}.pagination a:hover{text-decoration:underline}.img-lightbox{cursor:pointer;transition:opacity .2s}.img-lightbox:hover{opacity:.9}a.lightbox-overlay,a.lightbox-overlay:link,a.lightbox-overlay:visited,a.lightbox-overlay:hover,a.lightbox-overlay:active,a.lightbox-overlay:focus{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(255,255,255,.85) !important;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:9999;cursor:pointer;align-items:center;justify-content:center;padding:2rem;box-sizing:border-box;-webkit-tap-highlight-color:transparent;text-decoration:none !important;color:transparent !important;outline:none !important;border:none !important}.lightbox-overlay:target,a.lightbox-overlay:target{display:flex}.lightbox-overlay img{max-width:95%;max-height:95%;object-fit:contain;background:0 0;box-shadow:0 4px 20px rgba(0,0,0,.15);border-radius:4px}.feedback-footer{margin-top:.75rem;padding-top:.75rem;border-top:1px solid #e9ecef;text-align:center;color:#595959;font-size:.9rem;margin-bottom:2rem}.feedback-footer p{margin:0;line-height:1.6}.feedback-footer a{color:#007acc;text-decoration:none}.feedback-footer a:hover{text-decoration:underline}#newsletter-form-container{display:flex;flex-direction:column;align-items:center;margin:2rem 0}.newsletter-form{margin:0;display:flex;gap:.5rem;align-items:center;max-width:300px;width:100%}.form-group{flex:1;min-width:0}.newsletter-input{width:100%;padding:.5rem .75rem;font-size:.9rem;border:1px solid #e9ecef;border-radius:0;font-family:inherit;color:#333;background-color:#fff;transition:border-color .2s}.newsletter-input:focus{outline:none;border-color:#333}.newsletter-button{padding:.5rem 1rem;font-size:.9rem;background-color:transparent;color:#333;border:1px solid #333;border-radius:0;cursor:pointer;font-family:inherit;font-weight:400;white-space:nowrap;transition:background-color .2s,color .2s}.newsletter-button:hover:not(:disabled){background-color:#333;color:#fff}.newsletter-button:disabled{opacity:.5;cursor:not-allowed}.subscriber-count{margin:.75rem 0 0;font-size:.85rem;color:#595959;text-align:center}.newsletter-message{margin:1.5rem 0 0;padding:0;border-radius:0;line-height:1.6;text-align:center;max-width:300px;width:100%}.newsletter-message-success{background-color:transparent;color:#333;border:none}.newsletter-message-error{background-color:transparent;color:#595959;border:none}.newsletter-message a{color:#007acc;text-decoration:none}.newsletter-message a:hover{text-decoration:underline}.newsletter-archive{margin:2rem 0}.newsletter-list{list-style:none;padding:0}.newsletter-item{margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid #e9ecef}.newsletter-item:last-child{border-bottom:none}.newsletter-date{color:#595959;font-size:.9rem;margin-right:.5rem;min-width:120px;display:inline-block}.newsletter-item a{color:#333;text-decoration:none}.newsletter-item a:hover{color:#007acc;text-decoration:underline}@media screen and (max-width:768px){html{font-size:8px !important}body{font-size:1rem !important}.sidebar{width:90px !important;min-width:90px !important;padding:.75rem !important}.container{max-width:600px !important;margin:0 20px !important}.content{max-width:400px !important;padding:1rem !important;padding-bottom:.5rem !important;overflow-x:hidden !important;min-width:0 !important}.pagination{margin-bottom:1.5rem !important;padding-bottom:1.5rem !important}.project-tag{padding:1px 3px !important;border-radius:1.5px !important;font-size:4.5px !important;letter-spacing:.15px !important;margin-left:3px !important}.archive-meta{width:30px !important}.post-title,.post-title a,.single .post-title{line-height:1.2 !important}.post-content p:last-child{margin-bottom:.25rem !important}.feedback-footer{margin-top:.5rem !important;padding-top:.5rem !important;margin-bottom:1rem !important}#newsletter-form-container{margin:1rem 0 !important}.newsletter-form{max-width:200px !important}.newsletter-message{max-width:200px !important}.newsletter-date{display:block !important;margin-bottom:.25rem !important;min-width:auto !important}}code{font-family:sfmono-regular,Consolas,liberation mono,Menlo,Monaco,monospace;font-size:.875rem;line-height:1.5}p code,li code,td code,h1 code,h2 code,h3 code,h4 code,h5 code,h6 code{background-color:#f6f8fa;padding:.2em .4em;border-radius:4px;font-size:.875em;color:#24292f;word-break:break-word}pre{background-color:#f6f8fa;border-radius:6px;padding:0;margin:1rem 0;overflow:hidden}.highlight{margin:1rem 0;border-radius:6px;overflow:hidden;background-color:#f6f8fa;max-width:100%}.highlight pre{margin:0;background-color:transparent;border-radius:0;overflow-x:auto}.highlight table,.highlight .lntable{width:100%;border-collapse:collapse;border-spacing:0;padding:0;margin:0;border:0;display:table}.highlight table td,.highlight .lntd{padding:0;margin:0;border:0;vertical-align:top}.highlight .lntd:first-child{width:3.5rem;min-width:3.5rem;user-select:none;background-color:#ebedf0;border-right:1px solid #d0d7de}.highlight .lntd:first-child pre{padding:0;margin:0;overflow:hidden}.highlight .lntd:first-child pre code{display:block;padding:1rem 0}.highlight .lnt,.highlight .ln{display:block;padding:0 .75rem;color:#6e7781;text-align:right;font-size:inherit;line-height:inherit;white-space:pre;user-select:none}.highlight .lntd:last-child{overflow-x:auto}.highlight .lntd:last-child pre{padding:0;margin:0;overflow-x:auto}.highlight .lntd:last-child pre code{display:block;white-space:pre;word-wrap:normal;overflow-x:visible;padding:1rem}.chroma .line{display:block;padding:0;margin:0}.chroma .cl{display:block}.chroma .hl{background-color:#fff8c5}.bg{background-color:#f6f8fa}.chroma{background-color:#f6f8fa;color:#1f2328}.chroma .err{color:#cf222e;background-color:transparent}.chroma .k{color:#cf222e}.chroma .kc{color:#cf222e}.chroma .kd{color:#cf222e}.chroma .kn{color:#cf222e}.chroma .kp{color:#cf222e}.chroma .kr{color:#cf222e}.chroma .kt{color:#cf222e}.chroma .na{color:#1f2328}.chroma .nc{color:#1f2328}.chroma .no{color:#0550ae}.chroma .nd{color:#8250df}.chroma .ni{color:#6639ba}.chroma .nl{color:#0550ae;font-weight:700}.chroma .nn{color:#24292e}.chroma .nx{color:#1f2328}.chroma .nt{color:#116329}.chroma .nb{color:#6639ba}.chroma .bp{color:#6a737d}.chroma .nv{color:#953800}.chroma .vc{color:#953800}.chroma .vg{color:#953800}.chroma .vi{color:#953800}.chroma .vm{color:#953800}.chroma .nf{color:#8250df}.chroma .fm{color:#8250df}.chroma .s{color:#0a3069}.chroma .sa{color:#0a3069}.chroma .sb{color:#0a3069}.chroma .sc{color:#0a3069}.chroma .dl{color:#0a3069}.chroma .sd{color:#0a3069}.chroma .s2{color:#0a3069}.chroma .se{color:#0a3069}.chroma .sh{color:#0a3069}.chroma .si{color:#0a3069}.chroma .sx{color:#0a3069}.chroma .sr{color:#0a3069}.chroma .s1{color:#0a3069}.chroma .ss{color:#032f62}.chroma .m{color:#0550ae}.chroma .mb{color:#0550ae}.chroma .mf{color:#0550ae}.chroma .mh{color:#0550ae}.chroma .mi{color:#0550ae}.chroma .il{color:#0550ae}.chroma .mo{color:#0550ae}.chroma .o{color:#0550ae}.chroma .ow{color:#cf222e}.chroma .p{color:#1f2328}.chroma .c{color:#6e7781;font-style:italic}.chroma .ch{color:#6e7781;font-style:italic}.chroma .cm{color:#6e7781;font-style:italic}.chroma .c1{color:#6e7781;font-style:italic}.chroma .cs{color:#6e7781;font-style:italic}.chroma .cp{color:#6e7781}.chroma .cpf{color:#6e7781}.chroma .gd{color:#82071e;background-color:#ffebe9}.chroma .ge{font-style:italic}.chroma .gi{color:#116329;background-color:#dafbe1}.chroma .go{color:#1f2328}.chroma .gl{text-decoration:underline}.chroma .gs{font-weight:700}.chroma .w{color:#f6f8fa}@media screen and (max-width:768px){.highlight{max-width:100%;width:100%;overflow-x:auto}.highlight table,.highlight .lntable{width:auto;min-width:100%;table-layout:auto}.highlight .lntd:first-child{width:2.5rem;min-width:2.5rem}.highlight .lnt,.highlight .ln{padding:0 .5rem;font-size:inherit}code{font-size:.75rem}.highlight .lntd:first-child pre code{padding:.75rem 0}.highlight .lntd:last-child pre code{padding:.75rem}}</style><link rel=icon type=image/png href=/icons/favicon-96x96.png sizes=96x96><link rel=icon type=image/svg+xml href=/icons/favicon.svg><link rel="shortcut icon" href=/icons/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><meta name=apple-mobile-web-app-title content="philippdubach.com"><link rel=manifest href=/icons/site.webmanifest><meta name=theme-color content="#2c3e50"><meta name=msapplication-TileColor content="#2c3e50"><meta property="og:title" content="Building a Real-Time HN Archive: Cloudflare Workers, AI, and 100K Posts"><meta property="og:description" content="A deep dive into building a serverless Hacker News archiver using Cloudflare Workers, D1, Workers AI for topic classification, and Vectorize for semantic search. Architecture patterns for real-time data collection at scale."><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/standalone/hn-archiver/"><meta property="og:site_name" content="philippdubach.com"><meta property="og:locale" content="en_US"><meta property="og:logo" content="http://localhost:1313/icons/favicon.ico"><meta property="og:image" content="https://static.philippdubach.com/ograph/ograph-hn-technical.jpg"><meta property="og:image:secure_url" content="https://static.philippdubach.com/ograph/ograph-hn-technical.jpg"><meta property="og:image:url" content="https://static.philippdubach.com/ograph/ograph-hn-technical.jpg"><meta property="og:image:type" content="image/jpeg"><meta property="article:published_time" content="0001-01-01T00:00:00Z"><meta property="article:modified_time" content="0001-01-01T00:00:00Z"><meta property="article:section" content="standalone"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Building a Real-Time HN Archive: Cloudflare Workers, AI, and 100K Posts"><meta name=twitter:description content="A deep dive into building a serverless Hacker News archiver using Cloudflare Workers, D1, Workers AI for topic classification, and Vectorize for semantic search. Architecture patterns for real-time data collection at scale."><meta name=twitter:image content="https://static.philippdubach.com/ograph/ograph-hn-technical.jpg"><meta name=twitter:image:src content="https://static.philippdubach.com/ograph/ograph-hn-technical.jpg"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"http:\/\/localhost:1313\/"},{"@type":"ListItem","position":2,"name":"Standalone","item":"http:\/\/localhost:1313\/standalone/"},{"@type":"ListItem","position":3,"name":"Building a Real-Time HN Archive: Cloudflare Workers, AI, and 100K Posts","item":"http:\/\/localhost:1313\/standalone\/hn-archiver\/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Building a Real-Time HN Archive: Cloudflare Workers, AI, and 100K Posts","name":"Building a Real-Time HN Archive: Cloudflare Workers, AI, and 100K Posts","description":"A deep dive into building a serverless Hacker News archiver using Cloudflare Workers, D1, Workers AI for topic classification, and Vectorize for semantic search. Architecture patterns for real-time data collection at scale.","keywords":["Cloudflare Workers","D1 database","Workers AI","Vectorize","serverless architecture","real-time archiving","Hacker News API","TypeScript","cron jobs","embeddings","semantic search","data engineering"],"articleBody":"\" This is the technical companion to The First Two Hours: What 100,000 HN Posts Reveal About Online Attention. For the research results, see The Attention Paradox.\\nI wanted to study how attention flows on Hacker News, but existing datasets only capture snapshots. To understand temporal patterns, score velocity, and content lifecycle, I needed continuous observation. So I built a real-time archiver.\\nThe system runs entirely on Cloudflare\\u0026rsquo;s edge platform: Workers for compute, D1 for storage, Workers AI for classification, and Vectorize for similarity search. After a week of operation, it had collected 98,586 items with 22,457 temporal snapshots, enough data to reveal some surprising patterns about how online attention works.\\nHere\\u0026rsquo;s how it works.\\nArchitecture Overview Three cron-triggered workers handle the data pipeline:\\nWorker Schedule Function Discovery Every 3 min Fetches new items from lastSeen+1 to current maxitem Updates Every 10 min Refreshes recently changed items via /v0/updates Backfill Every 2 hours Revisits stale high-value items, runs AI analysis, generates embeddings The HN API is straightforward. /v0/maxitem returns the highest item ID, /v0/updates returns recently changed items and profiles. Individual items come from /v0/item/{id}. Firebase-style, real-time capable, but I opted for polling to stay within rate limits.\\nDiscovery: Catching New Content The discovery worker runs every 3 minutes. It reads the last seen item ID from state, fetches the current max from HN, then iterates through the gap:\\n1 2 3 4 5 6 7 8 9 10 11 12 13 export async function runDiscovery(env: WorkerEnv): Promise\\u0026lt;WorkerResult\\u0026gt; { const state = await getArchivingState(env.DB); const currentMaxId = await fetchMaxItemId(); const startId = state.maxItemIdSeen + 1; const endId = Math.min(currentMaxId, startId + BATCH_SIZE - 1); const items = await fetchItemsBatch(startId, endId); const result = await batchUpsertItems(env.DB, items, getCurrentTimestampMs()); await updateMaxItemId(env.DB, endId); return result; } Batch size is capped at 500 items per run. During peak hours, HN generates 50-100 new items per minute, so 3-minute intervals with 500-item batches keeps up comfortably.\\nThe batchUpsertItems function is where things get interesting. It\\u0026rsquo;s designed for idempotency:\\nFetch existing items by ID Compare each field to detect actual changes Only write rows that differ Create snapshots based on change magnitude This means re-running discovery on the same ID range is safe. The function returns { processed, changed, snapshots } counts for monitoring.\\nSnapshots: Capturing Score Evolution Not every update deserves a snapshot. Writing 100K snapshots per day would exhaust D1\\u0026rsquo;s row limits quickly. Instead, I use selective triggers:\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 function shouldCreateSnapshot( existing: HNItem | null, incoming: HNItem, reason: string ): boolean { if (reason === \\u0026#39;new_item\\u0026#39;) return true; if (reason === \\u0026#39;front_page\\u0026#39;) return true; if (existing \\u0026amp;\\u0026amp; incoming.score - existing.score \\u0026gt;= 20) { return true; // score_spike } // Sample every 4th update if (existing \\u0026amp;\\u0026amp; existing.update_count % 4 === 0) { return true; } return false; } The snapshot_reason enum captures why each snapshot was created: score_spike, front_page, sample, or new_item. This metadata proved essential for the research analysis, letting me filter for specific observation types.\\nSnapshot schema:\\n1 2 3 4 5 6 7 8 9 10 11 CREATE TABLE item_snapshots ( id INTEGER PRIMARY KEY AUTOINCREMENT, item_id INTEGER NOT NULL, score INTEGER, descendants INTEGER, snapshot_reason TEXT, created_at INTEGER NOT NULL, FOREIGN KEY (item_id) REFERENCES items(id) ); CREATE INDEX idx_snapshots_item_time ON item_snapshots(item_id, created_at); The compound index on (item_id, created_at) makes lifecycle queries fast: \\u0026ldquo;Give me all snapshots for item X ordered by time.\\u0026rdquo;\\nAI Classification Pipeline Every story gets three AI treatments:\\nTopic Classification uses @cf/meta/llama-3.2-1b-instruct with a structured prompt:\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 const TOPIC_PROMPT = `Classify this Hacker News story into exactly one category. Categories: artificial-intelligence, programming, web-development, startups, science, security, crypto-blockchain, hardware, career, politics, business, gaming, other Title: ${title} URL: ${url} Respond with only the category name.`; const response = await env.AI.run(\\u0026#39;@cf/meta/llama-3.2-1b-instruct\\u0026#39;, { prompt: TOPIC_PROMPT, max_tokens: 20, temperature: 0.1 }); Low temperature (0.1) keeps responses consistent. The 13-category taxonomy emerged from initial clustering of HN content types.\\nSentiment Analysis uses @cf/huggingface/distilbert-sst-2-int8:\\n1 2 3 4 5 const sentiment = await env.AI.run( \\u0026#39;@cf/huggingface/distilbert-sst-2-int8\\u0026#39;, { text: title } ); // Returns: [{ label: \\u0026#34;POSITIVE\\u0026#34;|\\u0026#34;NEGATIVE\\u0026#34;, score: 0-1 }] Embeddings for similarity search use @cf/baai/bge-base-en-v1.5:\\n1 2 3 4 5 6 7 8 9 10 const embedding = await env.AI.run(\\u0026#39;@cf/baai/bge-base-en-v1.5\\u0026#39;, { text: `${title} ${url}` }); // Returns: { data: [[...768 floats]] } await env.VECTORIZE.insert([{ id: itemId.toString(), values: embedding.data[0], metadata: { topic: item.ai_topic, score: item.score } }]); The 768-dimensional BGE embeddings go into Cloudflare\\u0026rsquo;s Vectorize index for cosine similarity search. Finding related posts becomes a single API call:\\n1 const similar = await env.VECTORIZE.query(embedding, { topK: 5 }); Budget Constraints Cloudflare\\u0026rsquo;s paid plan includes generous but finite quotas. The system is designed to stay well within them:\\n1 2 3 4 5 6 7 // src/types.ts export const BudgetLimits = { VECTORIZE_QUERIES_PER_DAY: 1500, VECTORIZE_MAX_STORED_VECTORS: 10000, EMBEDDING_BATCH_SIZE: 50, D1_READS_PER_DAY: 500_000_000 }; Usage tracking happens in the usage_counters table:\\n1 2 3 4 5 6 7 8 9 10 11 12 async function checkUsageLimits(db: D1Database, key: string): Promise\\u0026lt;boolean\\u0026gt; { const today = new Date().toISOString().split(\\u0026#39;T\\u0026#39;)[0]; const counter = await getUsageCounter(db, `${key}_${today}`); return counter \\u0026lt; BudgetLimits[key]; } async function incrementUsageCounter(db: D1Database, key: string, delta: number) { await db.prepare( `INSERT INTO usage_counters (key, value) VALUES (?, ?) ON CONFLICT(key) DO UPDATE SET value = value + ?` ).bind(key, delta, delta).run(); } The /api/usage endpoint exposes current consumption. Warnings appear at 80% of limits.\\nSecurity Patterns Several patterns keep the system safe:\\nRate limiting uses an in-memory map with 100 requests/IP/minute limit:\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 const rateLimitMap = new Map\\u0026lt;string, { count: number; resetAt: number }\\u0026gt;(); function checkRateLimit(ip: string): boolean { const now = Date.now(); const limit = rateLimitMap.get(ip); if (!limit || limit.resetAt \\u0026lt; now) { rateLimitMap.set(ip, { count: 1, resetAt: now + 60000 }); return true; } if (limit.count \\u0026gt;= 100) return false; limit.count++; return true; } Timing-safe auth comparison prevents timing attacks on the trigger secret:\\n1 2 3 4 5 6 7 import { timingSafeEqual } from \\u0026#39;./utils\\u0026#39;; function validateAuth(header: string | null, secret: string): boolean { if (!header?.startsWith(\\u0026#39;Bearer \\u0026#39;)) return false; const token = header.slice(7); return timingSafeEqual(token, secret); } Fail-closed auth returns 503 if TRIGGER_SECRET isn\\u0026rsquo;t configured, never proceeds with missing credentials:\\n1 2 3 if (!env.TRIGGER_SECRET) { return new Response(\\u0026#39;Auth not configured\\u0026#39;, { status: 503 }); } Parameterized SQL everywhere. No string interpolation, ever:\\n1 2 3 4 5 6 7 8 9 // Good const items = await db.prepare( \\u0026#39;SELECT * FROM items WHERE id = ?\\u0026#39; ).bind(itemId).all(); // Never const items = await db.prepare( `SELECT * FROM items WHERE id = ${itemId}` // SQL injection risk ).all(); Local Development The full stack runs locally via Wrangler:\\n1 2 3 4 5 6 7 8 # Initialize local D1 npx wrangler d1 execute hn-archiver --local --file=schema.sql # Start dev server npm run dev # localhost:8787 # Trigger workers manually curl -H \\u0026#34;Authorization: Bearer $SECRET\\u0026#34; localhost:8787/trigger/discovery For testing, Vitest with Miniflare provides mocked D1/AI/Vectorize bindings:\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 describe(\\u0026#39;batchUpsertItems\\u0026#39;, () =\\u0026gt; { it(\\u0026#39;creates snapshots on score spikes\\u0026#39;, async () =\\u0026gt; { const db = await getMiniflareD1(); // Insert initial item await batchUpsertItems(db, [{ id: 1, score: 10, ... }], now); // Update with 25-point jump const result = await batchUpsertItems(db, [{ id: 1, score: 35, ... }], now + 1000); expect(result.snapshots).toBe(1); const snapshot = await db.prepare( \\u0026#39;SELECT * FROM item_snapshots WHERE item_id = 1\\u0026#39; ).first(); expect(snapshot.snapshot_reason).toBe(\\u0026#39;score_spike\\u0026#39;); }); }); What I Learned Building this system taught me several lessons:\\nIdempotency matters for data pipelines. Cron jobs fail, restart, and overlap. Every write operation needs to handle re-runs gracefully. The upsert pattern with change detection made debugging much simpler.\\nSelective snapshots beat exhaustive logging. I initially tried capturing every score change. D1\\u0026rsquo;s row limits forced a better approach. The trigger-based system captures the interesting moments while staying within budget.\\nEdge AI is production-ready. Workers AI handled 50 stories per backfill run without issues. Latency is acceptable (200-500ms per classification), and the models are good enough for research categorization. I wouldn\\u0026rsquo;t use them for customer-facing classification without human review, but for analytics they work well.\\nBudget awareness should be built in. Tracking usage counters from day one prevented nasty surprises. The 10K vector limit in Vectorize shaped the retention policy: I only embed high-scoring stories, not every comment.\\nThe full source is at github.com/philippdubach/hn-archiver. Analysis code is at github.com/philippdubach/hn-analyzer. PRs welcome.\\nThe architecture patterns here, serverless cron workers, idempotent upserts, selective event capture, edge AI classification, transfer directly to enterprise use cases. I\\u0026rsquo;ve applied similar approaches to client analytics systems in banking, where real-time behavioral data feeds ML models for personalization and next-best-action recommendations. The technical constraints differ (compliance, latency requirements, integration complexity), but the core design principles remain: build for observability, design for failure, and let budget constraints shape architecture decisions early.\\n\"","wordCount":1500,"inLanguage":"en","image":"https:\/\/static.philippdubach.com\/ograph\/ograph-hn-technical.jpg","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/localhost:1313\/standalone\/hn-archiver\/"},"publisher":{"@type":"Organization","name":"philippdubach","logo":{"@type":"ImageObject","url":"http:\/\/localhost:1313\/icons/favicon.ico"}},"author":{"@type":"Person","name":"Philipp Dubach"}}</script></head><body class=linkblog><a href=#main-content class=skip-link>Skip to main content</a><div class=container><aside class=sidebar role=complementary aria-label="Site navigation and information"><div class=sidebar-content><div class=site-header><div class=site-title><a href=http://localhost:1313/ aria-label="Home - philippdubach">philippdubach</a></div><p class=site-description>Blog about Personal Projects, Articles and Papers on Economics, Finance and Technology</p></div><nav class=navigation aria-label="Main navigation"><ul><li><a href=/>Home</a></li><li><a href=/projects/>Projects</a></li><li><a href=/research/>Research</a></li><li><a href=/about/>About</a></li><li><a href=/posts/>Archive</a></li><li><a href=/subscribe>Subscribe</a></li></ul></nav><div class=social-links aria-label="Social media links"><a href=https://github.com/philippdubach target=_blank rel=noopener aria-label="GitHub profile (opens in new tab)">GitHub</a>
<a href=mailto:info@philippdubach.com aria-label="Send email">Email</a></div></div></aside><main id=main-content class=content role=main><article class="post single"><header class=post-header><h1 class=post-title>Building a Real-Time HN Archive: Cloudflare Workers, AI, and 100K Posts</h1></header><div class=post-content><blockquote><p><em>This is the technical companion to <a href=/>The First Two Hours: What 100,000 HN Posts Reveal About Online Attention</a>. For the research results, see <a href=/standalone/hn-research/>The Attention Paradox</a>.</em></p></blockquote><p>I wanted to study how attention flows on Hacker News, but existing datasets only capture snapshots. To understand temporal patterns, score velocity, and content lifecycle, I needed continuous observation. So I built a real-time archiver.</p><p>The system runs entirely on Cloudflare&rsquo;s edge platform: Workers for compute, D1 for storage, Workers AI for classification, and Vectorize for similarity search. After a week of operation, it had collected 98,586 items with 22,457 temporal snapshots, enough data to reveal some surprising patterns about how online attention works.</p><p>Here&rsquo;s how it works.</p><h2 id=architecture-overview>Architecture Overview</h2><a href=#lightbox-hn_architecture-png-0 style="display:block;width:100%;margin:0 auto;padding:1rem 0;text-decoration:none"><picture class=img-lightbox><source media="(max-width: 768px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=320,quality=80,format=webp/hn_architecture.png 320w,
https://static.philippdubach.com/cdn-cgi/image/width=480,quality=80,format=webp/hn_architecture.png 480w,
https://static.philippdubach.com/cdn-cgi/image/width=640,quality=80,format=webp/hn_architecture.png 640w" sizes=100%><source media="(max-width: 1024px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=768,quality=80,format=webp/hn_architecture.png 768w,
https://static.philippdubach.com/cdn-cgi/image/width=1024,quality=80,format=webp/hn_architecture.png 1024w" sizes=100%><source media="(min-width: 1025px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=1200,quality=80,format=webp/hn_architecture.png 1200w,
https://static.philippdubach.com/cdn-cgi/image/width=1600,quality=80,format=webp/hn_architecture.png 1600w,
https://static.philippdubach.com/cdn-cgi/image/width=2000,quality=80,format=webp/hn_architecture.png 2000w" sizes=100%><img src="https://static.philippdubach.com/cdn-cgi/image/width=1200,quality=80/hn_architecture.png" alt="System architecture: HN API to Workers to D1 to AI to Vectorize" width=1200 loading=lazy style=width:100%;height:auto;display:block>
</picture></a><a href=#_ id=lightbox-hn_architecture-png-0 class=lightbox-overlay><img src="https://static.philippdubach.com/cdn-cgi/image/width=2000,quality=90,format=webp/hn_architecture.png" alt="System architecture: HN API to Workers to D1 to AI to Vectorize" loading=lazy></a><p>Three cron-triggered workers handle the data pipeline:</p><table><thead><tr><th>Worker</th><th>Schedule</th><th>Function</th></tr></thead><tbody><tr><td><strong>Discovery</strong></td><td>Every 3 min</td><td>Fetches new items from <code>lastSeen+1</code> to current <code>maxitem</code></td></tr><tr><td><strong>Updates</strong></td><td>Every 10 min</td><td>Refreshes recently changed items via <code>/v0/updates</code></td></tr><tr><td><strong>Backfill</strong></td><td>Every 2 hours</td><td>Revisits stale high-value items, runs AI analysis, generates embeddings</td></tr></tbody></table><p>The HN API is straightforward. <code>/v0/maxitem</code> returns the highest item ID, <code>/v0/updates</code> returns recently changed items and profiles. Individual items come from <code>/v0/item/{id}</code>. Firebase-style, real-time capable, but I opted for polling to stay within rate limits.</p><a href=#lightbox-hn_cron_timeline-png-1 style="display:block;width:100%;margin:0 auto;padding:1rem 0;text-decoration:none"><picture class=img-lightbox><source media="(max-width: 768px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=320,quality=80,format=webp/hn_cron_timeline.png 320w,
https://static.philippdubach.com/cdn-cgi/image/width=480,quality=80,format=webp/hn_cron_timeline.png 480w,
https://static.philippdubach.com/cdn-cgi/image/width=640,quality=80,format=webp/hn_cron_timeline.png 640w" sizes=100%><source media="(max-width: 1024px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=768,quality=80,format=webp/hn_cron_timeline.png 768w,
https://static.philippdubach.com/cdn-cgi/image/width=1024,quality=80,format=webp/hn_cron_timeline.png 1024w" sizes=100%><source media="(min-width: 1025px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=1200,quality=80,format=webp/hn_cron_timeline.png 1200w,
https://static.philippdubach.com/cdn-cgi/image/width=1600,quality=80,format=webp/hn_cron_timeline.png 1600w,
https://static.philippdubach.com/cdn-cgi/image/width=2000,quality=80,format=webp/hn_cron_timeline.png 2000w" sizes=100%><img src="https://static.philippdubach.com/cdn-cgi/image/width=1200,quality=80/hn_cron_timeline.png" alt="Cron execution timeline showing worker frequency over 2 hours" width=1200 loading=lazy style=width:100%;height:auto;display:block>
</picture></a><a href=#_ id=lightbox-hn_cron_timeline-png-1 class=lightbox-overlay><img src="https://static.philippdubach.com/cdn-cgi/image/width=2000,quality=90,format=webp/hn_cron_timeline.png" alt="Cron execution timeline showing worker frequency over 2 hours" loading=lazy></a><h2 id=discovery-catching-new-content>Discovery: Catching New Content</h2><p>The discovery worker runs every 3 minutes. It reads the last seen item ID from state, fetches the current max from HN, then iterates through the gap:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>runDiscovery</span><span class=p>(</span><span class=nx>env</span>: <span class=kt>WorkerEnv</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>WorkerResult</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>state</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>getArchivingState</span><span class=p>(</span><span class=nx>env</span><span class=p>.</span><span class=nx>DB</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>currentMaxId</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>fetchMaxItemId</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>startId</span> <span class=o>=</span> <span class=nx>state</span><span class=p>.</span><span class=nx>maxItemIdSeen</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>endId</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(</span><span class=nx>currentMaxId</span><span class=p>,</span> <span class=nx>startId</span> <span class=o>+</span> <span class=nx>BATCH_SIZE</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>fetchItemsBatch</span><span class=p>(</span><span class=nx>startId</span><span class=p>,</span> <span class=nx>endId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>batchUpsertItems</span><span class=p>(</span><span class=nx>env</span><span class=p>.</span><span class=nx>DB</span><span class=p>,</span> <span class=nx>items</span><span class=p>,</span> <span class=nx>getCurrentTimestampMs</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>updateMaxItemId</span><span class=p>(</span><span class=nx>env</span><span class=p>.</span><span class=nx>DB</span><span class=p>,</span> <span class=nx>endId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Batch size is capped at 500 items per run. During peak hours, HN generates 50-100 new items per minute, so 3-minute intervals with 500-item batches keeps up comfortably.</p><p>The <code>batchUpsertItems</code> function is where things get interesting. It&rsquo;s designed for idempotency:</p><ol><li>Fetch existing items by ID</li><li>Compare each field to detect actual changes</li><li>Only write rows that differ</li><li>Create snapshots based on change magnitude</li></ol><p>This means re-running discovery on the same ID range is safe. The function returns <code>{ processed, changed, snapshots }</code> counts for monitoring.</p><h2 id=snapshots-capturing-score-evolution>Snapshots: Capturing Score Evolution</h2><p>Not every update deserves a snapshot. Writing 100K snapshots per day would exhaust D1&rsquo;s row limits quickly. Instead, I use selective triggers:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>shouldCreateSnapshot</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>existing</span>: <span class=kt>HNItem</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>incoming</span>: <span class=kt>HNItem</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>reason</span>: <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=kr>boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>reason</span> <span class=o>===</span> <span class=s1>&#39;new_item&#39;</span><span class=p>)</span> <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>reason</span> <span class=o>===</span> <span class=s1>&#39;front_page&#39;</span><span class=p>)</span> <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>existing</span> <span class=o>&amp;&amp;</span> <span class=nx>incoming</span><span class=p>.</span><span class=nx>score</span> <span class=o>-</span> <span class=nx>existing</span><span class=p>.</span><span class=nx>score</span> <span class=o>&gt;=</span> <span class=mi>20</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span> <span class=c1>// score_spike
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// Sample every 4th update
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>existing</span> <span class=o>&amp;&amp;</span> <span class=nx>existing</span><span class=p>.</span><span class=nx>update_count</span> <span class=o>%</span> <span class=mi>4</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>snapshot_reason</code> enum captures why each snapshot was created: <code>score_spike</code>, <code>front_page</code>, <code>sample</code>, or <code>new_item</code>. This metadata proved essential for the research analysis, letting me filter for specific observation types.</p><p>Snapshot schema:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>item_snapshots</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>AUTOINCREMENT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>item_id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>score</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>descendants</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>snapshot_reason</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>created_at</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>item_id</span><span class=p>)</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>items</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_snapshots_item_time</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>item_snapshots</span><span class=p>(</span><span class=n>item_id</span><span class=p>,</span><span class=w> </span><span class=n>created_at</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>The compound index on <code>(item_id, created_at)</code> makes lifecycle queries fast: &ldquo;Give me all snapshots for item X ordered by time.&rdquo;</p><h2 id=ai-classification-pipeline>AI Classification Pipeline</h2><a href=#lightbox-hn_ai_pipeline-png-2 style="display:block;width:100%;margin:0 auto;padding:1rem 0;text-decoration:none"><picture class=img-lightbox><source media="(max-width: 768px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=320,quality=80,format=webp/hn_ai_pipeline.png 320w,
https://static.philippdubach.com/cdn-cgi/image/width=480,quality=80,format=webp/hn_ai_pipeline.png 480w,
https://static.philippdubach.com/cdn-cgi/image/width=640,quality=80,format=webp/hn_ai_pipeline.png 640w" sizes=100%><source media="(max-width: 1024px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=768,quality=80,format=webp/hn_ai_pipeline.png 768w,
https://static.philippdubach.com/cdn-cgi/image/width=1024,quality=80,format=webp/hn_ai_pipeline.png 1024w" sizes=100%><source media="(min-width: 1025px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=1200,quality=80,format=webp/hn_ai_pipeline.png 1200w,
https://static.philippdubach.com/cdn-cgi/image/width=1600,quality=80,format=webp/hn_ai_pipeline.png 1600w,
https://static.philippdubach.com/cdn-cgi/image/width=2000,quality=80,format=webp/hn_ai_pipeline.png 2000w" sizes=100%><img src="https://static.philippdubach.com/cdn-cgi/image/width=1200,quality=80/hn_ai_pipeline.png" alt="AI pipeline: Raw story to Llama to DistilBERT to BGE to Vectorize" width=1200 loading=lazy style=width:100%;height:auto;display:block>
</picture></a><a href=#_ id=lightbox-hn_ai_pipeline-png-2 class=lightbox-overlay><img src="https://static.philippdubach.com/cdn-cgi/image/width=2000,quality=90,format=webp/hn_ai_pipeline.png" alt="AI pipeline: Raw story to Llama to DistilBERT to BGE to Vectorize" loading=lazy></a><p>Every story gets three AI treatments:</p><p><strong>Topic Classification</strong> uses <code>@cf/meta/llama-3.2-1b-instruct</code> with a structured prompt:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>TOPIC_PROMPT</span> <span class=o>=</span> <span class=sb>`Classify this Hacker News story into exactly one category.
</span></span></span><span class=line><span class=cl><span class=sb>Categories: artificial-intelligence, programming, web-development, startups, 
</span></span></span><span class=line><span class=cl><span class=sb>science, security, crypto-blockchain, hardware, career, politics, business, 
</span></span></span><span class=line><span class=cl><span class=sb>gaming, other
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>Title: </span><span class=si>${</span><span class=nx>title</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>URL: </span><span class=si>${</span><span class=nx>url</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>Respond with only the category name.`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>env</span><span class=p>.</span><span class=nx>AI</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=s1>&#39;@cf/meta/llama-3.2-1b-instruct&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>prompt</span>: <span class=kt>TOPIC_PROMPT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>max_tokens</span>: <span class=kt>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>temperature</span>: <span class=kt>0.1</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>Low temperature (0.1) keeps responses consistent. The 13-category taxonomy emerged from initial clustering of HN content types.</p><p><strong>Sentiment Analysis</strong> uses <code>@cf/huggingface/distilbert-sst-2-int8</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>sentiment</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>env</span><span class=p>.</span><span class=nx>AI</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;@cf/huggingface/distilbert-sst-2-int8&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=nx>text</span>: <span class=kt>title</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Returns: [{ label: &#34;POSITIVE&#34;|&#34;NEGATIVE&#34;, score: 0-1 }]
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Embeddings</strong> for similarity search use <code>@cf/baai/bge-base-en-v1.5</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>embedding</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>env</span><span class=p>.</span><span class=nx>AI</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=s1>&#39;@cf/baai/bge-base-en-v1.5&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>text</span><span class=o>:</span> <span class=sb>`</span><span class=si>${</span><span class=nx>title</span><span class=si>}</span><span class=sb> </span><span class=si>${</span><span class=nx>url</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// Returns: { data: [[...768 floats]] }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=nx>env</span><span class=p>.</span><span class=nx>VECTORIZE</span><span class=p>.</span><span class=nx>insert</span><span class=p>([{</span>
</span></span><span class=line><span class=cl>  <span class=nx>id</span>: <span class=kt>itemId.toString</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>  <span class=nx>values</span>: <span class=kt>embedding.data</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>metadata</span><span class=o>:</span> <span class=p>{</span> <span class=nx>topic</span>: <span class=kt>item.ai_topic</span><span class=p>,</span> <span class=nx>score</span>: <span class=kt>item.score</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}]);</span>
</span></span></code></pre></td></tr></table></div></div><p>The 768-dimensional BGE embeddings go into Cloudflare&rsquo;s Vectorize index for cosine similarity search. Finding related posts becomes a single API call:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>similar</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>env</span><span class=p>.</span><span class=nx>VECTORIZE</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=nx>embedding</span><span class=p>,</span> <span class=p>{</span> <span class=nx>topK</span>: <span class=kt>5</span> <span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=budget-constraints>Budget Constraints</h2><p>Cloudflare&rsquo;s paid plan includes generous but finite quotas. The system is designed to stay well within them:</p><a href=#lightbox-hn_budget_limits-png-3 style="display:block;width:90%;margin:0 auto;padding:1rem 0;text-decoration:none"><picture class=img-lightbox><source media="(max-width: 768px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=320,quality=80,format=webp/hn_budget_limits.png 320w,
https://static.philippdubach.com/cdn-cgi/image/width=480,quality=80,format=webp/hn_budget_limits.png 480w,
https://static.philippdubach.com/cdn-cgi/image/width=640,quality=80,format=webp/hn_budget_limits.png 640w" sizes=90%><source media="(max-width: 1024px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=768,quality=80,format=webp/hn_budget_limits.png 768w,
https://static.philippdubach.com/cdn-cgi/image/width=1024,quality=80,format=webp/hn_budget_limits.png 1024w" sizes=90%><source media="(min-width: 1025px)" srcset="https://static.philippdubach.com/cdn-cgi/image/width=1200,quality=80,format=webp/hn_budget_limits.png 1200w,
https://static.philippdubach.com/cdn-cgi/image/width=1600,quality=80,format=webp/hn_budget_limits.png 1600w,
https://static.philippdubach.com/cdn-cgi/image/width=2000,quality=80,format=webp/hn_budget_limits.png 2000w" sizes=90%><img src="https://static.philippdubach.com/cdn-cgi/image/width=1200,quality=80/hn_budget_limits.png" alt="Budget constraints: Vectorize queries, stored vectors, embeddings per run" width=1200 loading=lazy style=width:100%;height:auto;display:block>
</picture></a><a href=#_ id=lightbox-hn_budget_limits-png-3 class=lightbox-overlay><img src="https://static.philippdubach.com/cdn-cgi/image/width=2000,quality=90,format=webp/hn_budget_limits.png" alt="Budget constraints: Vectorize queries, stored vectors, embeddings per run" loading=lazy></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// src/types.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>BudgetLimits</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>VECTORIZE_QUERIES_PER_DAY</span>: <span class=kt>1500</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>VECTORIZE_MAX_STORED_VECTORS</span>: <span class=kt>10000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>EMBEDDING_BATCH_SIZE</span>: <span class=kt>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>D1_READS_PER_DAY</span>: <span class=kt>500_000_000</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>Usage tracking happens in the <code>usage_counters</code> table:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>checkUsageLimits</span><span class=p>(</span><span class=nx>db</span>: <span class=kt>D1Database</span><span class=p>,</span> <span class=nx>key</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>boolean</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>today</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>().</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>counter</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>getUsageCounter</span><span class=p>(</span><span class=nx>db</span><span class=p>,</span> <span class=sb>`</span><span class=si>${</span><span class=nx>key</span><span class=si>}</span><span class=sb>_</span><span class=si>${</span><span class=nx>today</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>counter</span> <span class=o>&lt;</span> <span class=nx>BudgetLimits</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>incrementUsageCounter</span><span class=p>(</span><span class=nx>db</span>: <span class=kt>D1Database</span><span class=p>,</span> <span class=nx>key</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>delta</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>prepare</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sb>`INSERT INTO usage_counters (key, value) VALUES (?, ?)
</span></span></span><span class=line><span class=cl><span class=sb>     ON CONFLICT(key) DO UPDATE SET value = value + ?`</span>
</span></span><span class=line><span class=cl>  <span class=p>).</span><span class=nx>bind</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>delta</span><span class=p>,</span> <span class=nx>delta</span><span class=p>).</span><span class=nx>run</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>/api/usage</code> endpoint exposes current consumption. Warnings appear at 80% of limits.</p><h2 id=security-patterns>Security Patterns</h2><p>Several patterns keep the system safe:</p><p><strong>Rate limiting</strong> uses an in-memory map with 100 requests/IP/minute limit:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>rateLimitMap</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=p>{</span> <span class=na>count</span><span class=err>:</span> <span class=na>number</span><span class=err>;</span> <span class=na>resetAt</span><span class=err>:</span> <span class=na>number</span> <span class=p>}&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>checkRateLimit</span><span class=p>(</span><span class=nx>ip</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=kr>boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>limit</span> <span class=o>=</span> <span class=nx>rateLimitMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>ip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>limit</span> <span class=o>||</span> <span class=nx>limit</span><span class=p>.</span><span class=nx>resetAt</span> <span class=o>&lt;</span> <span class=nx>now</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>rateLimitMap</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>ip</span><span class=p>,</span> <span class=p>{</span> <span class=nx>count</span>: <span class=kt>1</span><span class=p>,</span> <span class=nx>resetAt</span>: <span class=kt>now</span> <span class=o>+</span> <span class=mi>60000</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>limit</span><span class=p>.</span><span class=nx>count</span> <span class=o>&gt;=</span> <span class=mi>100</span><span class=p>)</span> <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>limit</span><span class=p>.</span><span class=nx>count</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Timing-safe auth comparison</strong> prevents timing attacks on the trigger secret:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>timingSafeEqual</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./utils&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>validateAuth</span><span class=p>(</span><span class=nx>header</span>: <span class=kt>string</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>secret</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=kr>boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>header</span><span class=o>?</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=s1>&#39;Bearer &#39;</span><span class=p>))</span> <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>header</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>timingSafeEqual</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>secret</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Fail-closed auth</strong> returns 503 if <code>TRIGGER_SECRET</code> isn&rsquo;t configured, never proceeds with missing credentials:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>env</span><span class=p>.</span><span class=nx>TRIGGER_SECRET</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>Response</span><span class=p>(</span><span class=s1>&#39;Auth not configured&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>status</span>: <span class=kt>503</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Parameterized SQL everywhere</strong>. No string interpolation, ever:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// Good
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>prepare</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;SELECT * FROM items WHERE id = ?&#39;</span>
</span></span><span class=line><span class=cl><span class=p>).</span><span class=nx>bind</span><span class=p>(</span><span class=nx>itemId</span><span class=p>).</span><span class=nx>all</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Never
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>prepare</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=sb>`SELECT * FROM items WHERE id = </span><span class=si>${</span><span class=nx>itemId</span><span class=si>}</span><span class=sb>`</span> <span class=c1>// SQL injection risk
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>).</span><span class=nx>all</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=local-development>Local Development</h2><p>The full stack runs locally via Wrangler:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Initialize local D1</span>
</span></span><span class=line><span class=cl>npx wrangler d1 execute hn-archiver --local --file<span class=o>=</span>schema.sql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Start dev server</span>
</span></span><span class=line><span class=cl>npm run dev  <span class=c1># localhost:8787</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Trigger workers manually</span>
</span></span><span class=line><span class=cl>curl -H <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$SECRET</span><span class=s2>&#34;</span> localhost:8787/trigger/discovery
</span></span></code></pre></td></tr></table></div></div><p>For testing, Vitest with Miniflare provides mocked D1/AI/Vectorize bindings:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;batchUpsertItems&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;creates snapshots on score spikes&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>db</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>getMiniflareD1</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Insert initial item
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>await</span> <span class=nx>batchUpsertItems</span><span class=p>(</span><span class=nx>db</span><span class=p>,</span> <span class=p>[{</span> <span class=nx>id</span>: <span class=kt>1</span><span class=p>,</span> <span class=nx>score</span>: <span class=kt>10</span><span class=p>,</span> <span class=p>...</span> <span class=p>}],</span> <span class=nx>now</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Update with 25-point jump
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>batchUpsertItems</span><span class=p>(</span><span class=nx>db</span><span class=p>,</span> <span class=p>[{</span> <span class=nx>id</span>: <span class=kt>1</span><span class=p>,</span> <span class=nx>score</span>: <span class=kt>35</span><span class=p>,</span> <span class=p>...</span> <span class=p>}],</span> <span class=nx>now</span> <span class=o>+</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>snapshots</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>snapshot</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>prepare</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;SELECT * FROM item_snapshots WHERE item_id = 1&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>).</span><span class=nx>first</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>expect</span><span class=p>(</span><span class=nx>snapshot</span><span class=p>.</span><span class=nx>snapshot_reason</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;score_spike&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=what-i-learned>What I Learned</h2><p>Building this system taught me several lessons:</p><p><strong>Idempotency matters for data pipelines.</strong> Cron jobs fail, restart, and overlap. Every write operation needs to handle re-runs gracefully. The upsert pattern with change detection made debugging much simpler.</p><p><strong>Selective snapshots beat exhaustive logging.</strong> I initially tried capturing every score change. D1&rsquo;s row limits forced a better approach. The trigger-based system captures the interesting moments while staying within budget.</p><p><strong>Edge AI is production-ready.</strong> Workers AI handled 50 stories per backfill run without issues. Latency is acceptable (200-500ms per classification), and the models are good enough for research categorization. I wouldn&rsquo;t use them for customer-facing classification without human review, but for analytics they work well.</p><p><strong>Budget awareness should be built in.</strong> Tracking usage counters from day one prevented nasty surprises. The 10K vector limit in Vectorize shaped the retention policy: I only embed high-scoring stories, not every comment.</p><p>The full source is at <a href=https://github.com/philippdubach/hn-archiver>github.com/philippdubach/hn-archiver</a>. Analysis code is at <a href=https://github.com/philippdubach/hn-analyzer>github.com/philippdubach/hn-analyzer</a>. PRs welcome.</p><hr><p>The architecture patterns here, serverless cron workers, idempotent upserts, selective event capture, edge AI classification, transfer directly to enterprise use cases. I&rsquo;ve applied similar approaches to client analytics systems in banking, where real-time behavioral data feeds ML models for personalization and next-best-action recommendations. The technical constraints differ (compliance, latency requirements, integration complexity), but the core design principles remain: build for observability, design for failure, and let budget constraints shape architecture decisions early.</p></div></article><footer class=feedback-footer><p>Have feedback, comments, or ideas? <a href=mailto:info@philippdubach.com>I'd love to hear from you</a>.</p><p class=latest-post>Latest: <a href=/2025/12/30/apples-ai-bet-playing-the-long-game-or-missing-the-moment/>Apple's AI Bet: Playing the Long Game or Missing the Moment?</a></p><p class=most-read id=top-post-week style=min-height:1.5em></p></footer><script>(function(){var e,n,t=document.getElementById("top-post-week");if(t&&fetch("https://weekly-top-goatcounter-api.philippd.workers.dev").then(function(e){return e.ok?e.json():Promise.reject()}).then(function(e){if(e.hits&&e.hits.length>0){var n=e.hits[0];t.innerHTML='Most read: <a href="'+n.path+'">'+n.title.replace(" - philippdubach.com","")+"</a>"}else t.remove()}).catch(function(){t.remove()}),n=document.getElementById("share-link"),e=document.getElementById("share-status"),!n)return;n.addEventListener("click",function(t){t.preventDefault(),e.textContent="...";var s,n=window.location.href;navigator.clipboard&&navigator.clipboard.write&&typeof ClipboardItem!="undefined"?(s=new ClipboardItem({"text/plain":fetch("https://pdub.click/yourls-api.php?signature=4807288869&action=shorturl&format=json&url="+encodeURIComponent(n)).then(function(e){return e.json()}).then(function(e){var t=e.shorturl||"";return new Blob([t],{type:"text/plain"})}).catch(function(){return new Blob([""],{type:"text/plain"})})}),navigator.clipboard.write([s]).then(function(){e.textContent="url copied",setTimeout(function(){e.textContent=""},2e3)}).catch(function(){e.textContent="error",setTimeout(function(){e.textContent=""},2e3)})):fetch("https://pdub.click/yourls-api.php?signature=4807288869&action=shorturl&format=json&url="+encodeURIComponent(n)).then(function(e){return e.json()}).then(function(t){var n=t.shorturl;n&&navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(n).then(function(){e.textContent="url copied",setTimeout(function(){e.textContent=""},2e3)}).catch(function(){e.textContent=n,setTimeout(function(){e.textContent=""},4e3)}):n?(e.textContent=n,setTimeout(function(){e.textContent=""},4e3)):(e.textContent="error",setTimeout(function(){e.textContent=""},2e3))}).catch(function(){e.textContent="error",setTimeout(function(){e.textContent=""},2e3)})})})()</script></main></div></body></html>