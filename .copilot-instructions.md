# Copilot Instructions for philippdubach.com

## Project Overview

This is a Hugo-based static blog site focused on quantitative finance, AI, and technology. The site is deployed to GitHub Pages and uses a custom theme with no external dependencies.

**Last Updated:** January 4, 2026

## Architecture

### Key Directories
- `layouts/` - Hugo templates (do not modify without understanding Hugo templating)
- `content/posts/` - Blog posts in Markdown format
- `static/css/custom.css` - All site styles (inlined during build)
- `data/navigation.yaml` - Site navigation structure
- `social-automation/worker/` - Cloudflare Worker for social media automation

### External Services
- **GoatCounter** (`philippdubach.goatcounter.com`) - Privacy-friendly analytics
- **Cloudflare Workers** (`pdub.click`) - URL shortening proxy
- **Cloudflare CDN** (`static.philippdubach.com`) - Image hosting with resizing
- **Cloudflare Workers AI** - LLM-powered social post generation
- **Bluesky** - Automated social posting

## Coding Standards

### Hugo Templates
- Use Hugo's built-in functions over custom logic where possible
- Always test templates with `hugo server` before committing
- Use `partialCached` for expensive partials that don't change per-page

### CSS
- Follow existing naming conventions (BEM-like where applicable)
- Mobile styles use `@media screen and (max-width: 768px)`
- All colors should use the established palette:
  - Primary text: `#333`
  - Secondary text: `#595959`
  - Links: `#007acc`
  - Borders: `#e9ecef`

### JavaScript
- Use vanilla JS only (no frameworks)
- Use IIFE pattern to avoid global scope pollution
- Always handle errors gracefully with `.catch()`
- Use `fetch()` for API calls with proper error handling
- Add `crossorigin="anonymous"` and `referrerpolicy="no-referrer"` to external scripts

### Cloudflare Workers
- Validate all input data before processing
- Use proper error boundaries in scheduled tasks
- Add `Cache-Control: no-store` headers for API responses
- Keep secrets in environment variables, never hardcode

### Content
- Post filenames: `YYYYMMDD-slug.md` (preferred) or `YYYY-MM-DD-slug.md`
- Always include `title`, `date`, and `description` in frontmatter
- Use `tags: ["Project"]` for project posts
- External links require `external_url` parameter

## Security Considerations

### Do NOT:
- Hardcode API keys or secrets in templates or worker code
- Use `unsafe` HTML without understanding the content source
- Bypass Content Security Policy headers
- Store sensitive data in client-side JavaScript
- Use iframes without `sandbox` attribute

### Content Security Policy
The CSP is defined in `layouts/partials/head.html`. If adding new external scripts:
1. Add the domain to appropriate CSP directives
2. Add preconnect hints (not dns-prefetch - preconnect implies it)
3. Add `crossorigin` and `referrerpolicy` attributes
4. Test that resources load correctly

### Iframe Security
When using the `table` shortcode or any iframe:
- Always use `sandbox` attribute with minimal permissions
- Add `loading="lazy"` for performance
- Include accessible `title` attribute

## Testing

Before committing:
```bash
# Build and check for errors
hugo --minify

# Run local server
hugo server -D

# Check for broken links (optional)
hugo --minify && npx linkinator ./public --recurse
```

### Social Automation Worker
```bash
cd social-automation/worker

# Install dependencies
npm install

# Test locally
npx wrangler dev

# Deploy
npx wrangler deploy
```

## Common Tasks

### Add a new blog post
```bash
hugo new posts/YYYYMMDD-title.md
```

### Add a new page
Create markdown file in `content/` with appropriate frontmatter.

### Modify navigation
Edit `data/navigation.yaml`

### Add new shortcode
Create template in `layouts/shortcodes/`

## Deployment

Deployment is automatic via GitHub Actions on push to `main`. The workflow:
1. Builds with Hugo
2. Deploys to GitHub Pages
3. Submits URLs to search engines via IndexNow

## Troubleshooting

### Build Fails
- Check Hugo version compatibility (requires v0.128.0+)
- Verify all content files have valid frontmatter
- Check for broken template references

### Styles Not Updating
- CSS is inlined from `static/css/custom.css`
- Clear browser cache or use incognito mode
- Verify the build completed successfully

### Images Not Loading
- Ensure images are on `static.philippdubach.com`
- Check CSP allows the image source
- Verify the `img` shortcode parameters
